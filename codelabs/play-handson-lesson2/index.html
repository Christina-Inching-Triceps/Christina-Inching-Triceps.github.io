
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Play Framewworkãƒãƒ³ã‚ºã‚ªãƒ³ 2ç« </title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="play-handson-lesson2"
                  title="Play Framewworkãƒãƒ³ã‚ºã‚ªãƒ³ 2ç« "
                  environment="web"
                  feedback-link="https://github.com/Christina-Inching-Triceps/scala-play_handson/issues">
    
      <google-codelab-step label="Dockerç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—" duration="0">
        <p>ãƒãƒ³ã‚ºã‚ªãƒ³ã§é–‹ç™ºã‚’è¡Œã†ãŸã‚ã®ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚<br> Dockerã‚’åˆ©ç”¨ã—ã¦ç’°å¢ƒã‚’ä½œæˆã—ã¦ã„ã‚‹ãŸã‚ã€æ‰‹é †å…¼èª¬æ˜è³‡æ–™ã¨ã—ã¦æœ¬ç« ã‚’æ®‹ã—ã¾ã™ã€‚<br> ãƒãƒ³ã‚ºã‚ªãƒ³ç”¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯Dockerè¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹çŠ¶æ…‹ã®ã‚‚ã®ã‚’é…ç½®ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã®ç« ã¯å¿…ãšã—ã‚‚ã”è‡ªèº«ã§å¯¾å¿œã—ã¦ã„ãŸã ãå¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br> ä»Šå¾Œè‡ªèº«ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹éš›ã‚„ã€ãƒãƒ³ã‚ºã‚ªãƒ³ç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹æˆãŒæ°—ã«ãªã‚‹äººã¯å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚</p>
<h2 is-upgraded>Lesson1ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ”ãƒ¼</h2>
<p>ã¾ãšã¯Lesson1ã§ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚<br> ã“ã‚Œã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã§ã‚‚Finderã‹ã‚‰ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚</p>
<pre><code>$ cd {repository_root}
$ cp -rp lesson1/example/play-handson lesson2/handson/

# ä»¥å¾Œã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§ä½œæ¥­ã‚’è¡Œã„ã¾ã™ã€‚
$ cd lesson2/handson/play-handson
</code></pre>
<h2 is-upgraded>Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h2>
<p>ç’°å¢ƒã¯Dockerã‚’åˆ©ç”¨ã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œã†ãŸã‚ã€DockerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã«ã¯Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</p>
<p>Windows: <a href="https://docs.docker.com/docker-for-windows/install/" target="_blank">Download</a><br> Mac:     <a href="https://docs.docker.com/docker-for-mac/install/" target="_blank">Download</a></p>
<h2 is-upgraded>Dockerã§Play-Scalaã®å®Ÿè¡Œç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
<p>project_rootç›´ä¸‹ã«docker-compose.yamlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ<br> ä»¥ä¸‹ã®å†…å®¹ã‚’docker-composeãƒ•ã‚¡ã‚¤ãƒ«ã«è²¼ã‚Šä»˜ã‘</p>
<p><code>docker-compose.yaml</code></p>
<pre><code># docker-composeã®æ§‹é€ ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š (ç¾æ™‚ç‚¹ã®æœ€æ–°)
version: &#39;3&#39;
# dockerã§åˆ©ç”¨ã—ãŸã„å„ã‚³ãƒ³ãƒ†ãƒŠ(service)ã‚’ã¾ã¨ã‚ã‚‹è¦ç´ 
services:
  # play-scalaã¨ã„ã†åå‰ã‚’ã¤ã‘ã¦ã€Serviceã‚’è¨­å®šã€‚ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã¯playã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠã«ãªã‚Šã¾ã™
  play-scala:
    # åˆ©ç”¨ã™ã‚‹imageã‚’æŒ‡å®šã€‚ä»Šå›ã¯java8ç³»ã§å‹•ä½œã™ã‚‹sbtã®æœ€æ–°imageã‚’æŒ‡å®šã—ã¦ã„ã¾ã™
    image: hseeberger/scala-sbt:8u242_1.3.8_2.13.1
    # ç‰¹ã«ã“ã ã‚ã‚Šã¯ãªã„ã®ã§ã€serviceåã¨containeråã‚’åŒã˜ã«ã—ã¦ã„ã¾ã™ã€‚
    container_name: play-scala
    # playã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ©ç”¨ãƒãƒ¼ãƒˆãŒ9000ç•ªãªã®ã§9000ã‚’æŒ‡å®šã€‚hostã‹ã‚‰ã‚‚9000ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™
    ports:
      - &#34;9000:9000&#34;
    # åˆå›èµ·å‹•æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¾¤ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã«volumesã«æŒ‡å®š
    volumes:
      - .:/source
      - ./.ivy2:/root/.ivy2
      - ./.sbt:/root/.sbt
      - ./.cache:/root/.cache
    working_dir: /source
    # ç«¯æœ«ã«å…¥ã£ã¦ä½œæ¥­ã™ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã€ç«¯æœ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹
    tty: true
    # ä»Šå¾ŒDBæ¥ç¶šã‚’è¡Œã†ãŸã‚ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å±ã•ã›ã‚‹
    networks:
      - app-net

# ä»Šå¾Œplay, dbé–“ã§ã®é€šä¿¡ãŒã‚ã‚‹ãŸã‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æ§‹ç¯‰
networks:
  app-net:
    driver: bridge
</code></pre>
<p>è²¼ã‚Šä»˜ã‘ãŒè¡ŒãˆãŸã‚‰ã€å®Ÿéš›ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦playãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<pre><code># project_root (docker-compose.yamlãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´æ‰€) ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
$ docker-compose up -d

# ... èµ·å‹•ã¾ã§å¾…ã¡ã¾ã™ ...
# èµ·å‹•ã‚’ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
$ docker-compose ps

# ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚Œã°ã€æ­£å¸¸ã«èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚
#    Name      Command   State           Ports
# -----------------------------------------------------
# play-scala   bash      Up      0.0.0.0:9000-&gt;9000/tcp

</code></pre>
<p>ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ãŒã§ããŸã‚‰ã€å®Ÿéš›ã«playã‚’èµ·å‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code># play-scalaã®ã‚³ãƒ³ãƒ†ãƒŠã«ã¯bashãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ã€bashã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
# imageã«ã‚ˆã£ã¦ã¯bashãŒå…¥ã£ã¦ã„ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§ã€ãã®æ™‚ã«ã¯ sh ãªã©ã§è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†
$ docker-compose exec play-scala bash

root@8f6b2156168d:/source# sbt
# ...
# ...
# ... èµ·å‹•å®Œäº†å¾Œã«ä¸€åº¦ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ãŒã€å‹•ä½œã«æ”¯éšœã¯ãªã„ã®ã§ä»Šå›ã¯ã‚¹ãƒ«ãƒ¼ã—ã¾ã™
[error] server failed to start on local:///root/.sbt/1.0/server/d2c10f28878e8945c341/sock. java.io.IOException: com.sun.jna.LastErrorException: [36] File name too long

# sbtãŒèµ·å‹•ã—ãŸã‚‰ run ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†
[play-handson] $ run
# ...
# ...
# ... ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰èµ·å‹•å®Œäº†
# --- (Running the application, auto-reloading is enabled) ---
#
# [info] p.c.s.AkkaHttpServer - Listening for HTTP on /0.0.0.0:9000
#
# (Server started, use Enter to stop and go back to the console...)

</code></pre>
<p>PlayãŒèµ·å‹•ã—ãŸã‚‰hostå´ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ä»¥ä¸‹ã®urlã‹ã‚‰ã‚µãƒ¼ãƒã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br><a href="http://localhost:9000" target="_blank">http://localhost:9000</a></p>
<p>ä»¥ä¸‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°èµ·å‹•ã¯æˆåŠŸã§ã™ã€‚<br><img style="width: 450.00px" src="img/4cbd8a66ae5f8c7f.png"></p>
<h2 is-upgraded>Dockerã§DBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
<p>MySQLã‚’åˆ©ç”¨ã™ã‚‹DBã®docker-composeè¨­å®šã‚’è¡Œãªã£ã¦ã„ãã¾ã™ã€‚<br><code>project_root</code> ç›´ä¸‹ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª/ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚<br><code>init.sql</code> ã‚’ä½œæˆã—ã¦ã„ã¾ã™ãŒã€ç¾çŠ¶åˆ©ç”¨ã—ãªã„ãŸã‚ä¸­èº«ã¯ç©ºã®ã¾ã¾ã¨ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚</p>
<pre><code>docker
â””â”€â”€ db
    â”œâ”€â”€ Dockerfile
    â”œâ”€â”€ init
    â”‚   â””â”€â”€ init.sql
    â”œâ”€â”€ my.cnf
    â””â”€â”€ mysql_data/
</code></pre>
<h3 is-upgraded>Dockerfileã®è¨­å®š</h3>
<p><code>doker/db/Dockerfile</code> ã‚’ç·¨é›†ã—ã¦ã„ãã¾ã™ã€‚<br> ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚</p>
<p><code>/docker/db/Dockerfile</code></p>
<pre><code># mysqlã¯5.7ã‚’ä½¿ç”¨
FROM mysql:5.7

# imageãŒdebianã®ãŸã‚ã€apt-getã§æ—¥æœ¬ã®localeã‚’è¿½åŠ 
RUN apt-get update &amp;&amp; \
    apt-get install -y locales &amp;&amp; \
    rm -rf /var/lib/apt/lists/* &amp;&amp; \
    echo &#34;ja_JP.UTF-8 UTF-8&#34; &gt; /etc/locale.gen &amp;&amp; \
    locale-gen ja_JP.UTF-8
ENV LC_ALL ja_JP.UTF-8

# docker/db/my.cnfã‚’dockerã‚¤ãƒ¡ãƒ¼ã‚¸ä¸Šã®/etc/...ã«ã‚³ãƒ”ãƒ¼ã—ã¦é…ç½®
COPY ./my.cnf /etc/mysql/conf.d/my.cnf
</code></pre>
<h3 is-upgraded>my.cnfã‚’é…ç½®</h3>
<p>å…ˆã»ã©ã®treeã®è¨­å®šã¨åŒæ§˜ã®ç®‡æ‰€ã«my.cnfãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¾ã™ã€‚<br> ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚</p>
<p><code>/docker/db/my.cnf</code></p>
<pre><code>[mysqld]
character_set_server=utf8mb4
default_authentication_plugin=mysql_native_password
collation-server=utf8mb4_bin

[mysqldump]
default-character-set=utf8mb4

[mysql]
default-character-set=utf8mb4
</code></pre>
<h3 is-upgraded>docker-composeã«DBã®è¨­å®šã‚’è¿½è¨˜</h3>
<p><code>docker-compose.yaml</code> ã«DBã®Serviceè¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚<br> ä»¥ä¸‹ã®è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚<br> ä»Šå›ã¯<code>twitter_clone</code>ã¨ã„ã†åå‰ã®DBã‚’ä½œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚</p>
<pre><code>  db:
    build: ./docker/db
    ports:
      - &#34;3306:3306&#34;
    container_name: db
    volumes:
      # åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹SQLãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹dir
      - ./docker/db/init:/docker-entrypoint-initdb.d
      # æ°¸ç¶šåŒ–ã™ã‚‹ã¨ãã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹dir
      - ./docker/db/mysql_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      # Containerå†…ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ
      MYSQL_DATABASE: twitter_clone
    networks:
      - app-net
</code></pre>
<p>æœ€çµ‚çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚Œã°OKã§ã™ã€‚</p>
<p><code>/docker-compose.yaml</code></p>
<pre><code>version: &#39;3&#39;
services:
  play-scala:
    image: hseeberger/scala-sbt:8u242_1.3.8_2.13.1
    container_name: play-scala
    ports:
      - &#34;9000:9000&#34;
    volumes:
      - .:/source
      - ./.ivy2:/root/.ivy2
      - ./.sbt:/root/.sbt
      - ./.cache:/root/.cache
    working_dir: /source
    tty: true
    networks:
      - app-net
  db:
    build: ./docker/db
    ports:
      - &#34;3306:3306&#34;
    container_name: db
    volumes:
      # åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹SQLãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹dir
      - ./docker/db/init:/docker-entrypoint-initdb.d
      # ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ã¨ãã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹dirã‚’æŒ‡å®š
      - ./docker/db/mysql_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      # DBå
      MYSQL_DATABASE:      twitter_clone
      # timezoneã‚’è¨­å®š
      TZ:                  Asia/Tokyo
    # play-scalaã¨åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã«ç½®ã
    networks:
      - app-net

networks:
  app-net:
    driver: bridge
</code></pre>
<p>è¨­å®šãŒå®Œäº†ã—ãŸãŸã‚ã€Serviceã®å‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<pre><code>$ docker-compose up -d
# ... èµ·å‹•ã¾ã§å¾…ã¡ã¾ã™ ...

# ... èµ·å‹•å®Œäº†ã—ãŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª ...
$ docker-compose ps
   Name                Command             State                 Ports
------------------------------------------------------------------------------------
db           docker-entrypoint.sh mysqld   Up      0.0.0.0:3306-&gt;3306/tcp, 33060/tcp
play-scala   bash                          Up      0.0.0.0:9000-&gt;9000/tcp

</code></pre>
<p>ã“ã‚Œã§Dockerã®è¨­å®šã¯å®Œäº†ã§ã™ã€‚<br> æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹MySQLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦æ¤œè¨¼ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>$ docker-compose exec db bash
root@703885e52d0c:/# mysql -u root -proot
# ... çœç•¥ ...

mysql&gt;
</code></pre>
<p>ã“ã®ã‚ˆã†ã«mysqlã«ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã¦ã„ã‚Œã°æˆåŠŸã§ã™ã€‚</p>
<h2 is-upgraded>Tips</h2>
<ul>
<li>dbåå¤‰æ›´ã‚’ã—ãŸå ´åˆãªã©ã¯<code>docker/db/mysql_data/*</code>ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã®å†èµ·å‹•ã‚’ã™ã‚‹</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Playframeworkã«DBæ¥ç¶šé–¢é€£ã®è¨­å®šã‚’è¿½åŠ " duration="0">
        <p>ã“ã“ã‹ã‚‰Playã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«DBæ¥ç¶šç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹Slickã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ãã¾ã™ã€‚</p>
<h2 is-upgraded>build.sbtã«ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ </h2>
<p>ä»Šå›ã¯play-slickã‚„slick-codegenã‚’åˆ©ç”¨ã—ã¦ç’°å¢ƒã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚</p>
<p>å¤–éƒ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯<code>build.sbt</code>ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚<br> Playã§ã¯<code>build.sbt</code>ã«ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€å¯¾è±¡ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<p>æœ¬ãƒãƒ³ã‚ºã‚ªãƒ³ã§åˆ©ç”¨ã™ã‚‹ã‚‚ã®ã¨ã—ã¦ã€ä»¥ä¸‹ã®ä¾å­˜é–¢é–¢ä¿‚ã‚’<code>build.sbt</code>ã¸è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>evolutions,
&#34;com.typesafe.play&#34;      %% &#34;play-slick&#34;            % &#34;5.0.0&#34;,
&#34;com.typesafe.play&#34;      %% &#34;play-slick-evolutions&#34; % &#34;5.0.0&#34;,
// play-slickã®5.0.0ã§ã¯slick 3.3.2ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€codegenã‚‚åŒæ§˜ã«3.3.2ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
// https://github.com/playframework/play-slick#all-releases
&#34;com.typesafe.slick&#34;     %% &#34;slick-codegen&#34;         % &#34;3.3.2&#34;,
// æŒ‡å®šã™ã¹ããƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯å…ˆ
// https://scala-slick.org/doc/3.3.1/database.html
&#34;mysql&#34;                   % &#34;mysql-connector-java&#34;  % &#34;6.0.6&#34;,
</code></pre>
<p>ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã™ã‚‹ã¨<code>build.sbt</code>ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br><code>build.sbt</code></p>
<pre><code>name := &#34;&#34;&#34;play-handson&#34;&#34;&#34;
organization := &#34;com.example&#34;

version := &#34;1.0-SNAPSHOT&#34;

lazy val root = (project in file(&#34;.&#34;)).enablePlugins(PlayScala)

scalaVersion := &#34;2.13.1&#34;

libraryDependencies ++= Seq(
  guice,
  evolutions,
  &#34;org.scalatestplus.play&#34; %% &#34;scalatestplus-play&#34;    % &#34;5.0.0&#34; % Test,
  &#34;com.typesafe.play&#34;      %% &#34;play-slick&#34;            % &#34;5.0.0&#34;,
  &#34;com.typesafe.play&#34;      %% &#34;play-slick-evolutions&#34; % &#34;5.0.0&#34;,
  // play-slickã®5.0.0ã§ã¯slick 3.3.2ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€codegenã‚‚åŒæ§˜ã«3.3.2ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
  // https://github.com/playframework/play-slick#all-releases
  &#34;com.typesafe.slick&#34;     %% &#34;slick-codegen&#34;         % &#34;3.3.2&#34;,
  // æŒ‡å®šã™ã¹ããƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯å…ˆ
  // https://scala-slick.org/doc/3.3.1/database.html
  &#34;mysql&#34;                   % &#34;mysql-connector-java&#34;  % &#34;6.0.6&#34;,
)
</code></pre>
<p>è¨­å®šã‚’è¿½åŠ ã—ãŸã‚‰ä¸€åº¦ã“ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>$ cd {project_root}
$ docker-compose exec play-scala bash
/source# sbt update
</code></pre>
<p>ä»Šå›è¿½åŠ ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå§‹ã¾ã‚Œã°è¨­å®šã¯OKã§ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="slick-evolutionsã®è¨­å®š" duration="0">
        <p>æ—©é€Ÿã§ã™ãŒè¿½åŠ ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã„ãã¾ã™ã€‚</p>
<p>Slickã®ãƒ„ãƒ¼ãƒ«ã«ã¯slick-evolutionsã¨ã„ã†DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã¨slick-codegenã¨ã„ã†DBã‹ã‚‰ã®ãƒ¢ãƒ‡ãƒ«å®Ÿè£…è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚<br> ã“ã“ã§ã¯evolutionsã‚’åˆ©ç”¨ã—ã¦DBã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã„ãã¾ã™ã€‚</p>
<p>evolutionsä»¥å¤–ã§ã¯Flywayã¨ã„ã†ã‚‚ã®ã‚‚åºƒãåˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ã‚‚ã—ã‹ã—ãŸã‚‰Flywayã®ã»ã†ãŒã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</p>
<h2 is-upgraded>DBã¸æ¥ç¶šã™ã‚‹ãŸã‚ã«confã‚’è¨­å®š</h2>
<p>slick-evolutionsã¯åå‰ã®é€šã‚ŠSlickã‚’çµŒç”±ã—ã¦DBã¸ã®æ¥ç¶šã‚’è¡Œã„ã¾ã™ã€‚<br> ãã®ãŸã‚ã¾ãšã¯slickãŒDBã¸æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«è¨­å®šã‚’ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>playã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§<code>application.conf</code>ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã‚’è¿½åŠ ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚<br> ä»Šå›ã¯mysqlã‚’åˆ©ç”¨ã™ã‚‹ã®ã§ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
<p><code>conf/application.conf</code></p>
<pre><code>slick.dbs {
  default {
    # mysqlã¨æ¥ç¶šã™ã‚‹ãŸã‚profileã«MySQLã®ã‚‚ã®ã‚’æŒ‡å®š
    profile = &#34;slick.jdbc.MySQLProfile$&#34;
    db {
      driver   = com.mysql.cj.jdbc.Driver,
      # dockerã§ã¯ã‚³ãƒ³ãƒ†ãƒŠåã‚’æŒ‡å®šã—ã¦é€šä¿¡å¯èƒ½ãªã®ã§dbã‚³ãƒ³ãƒ†ãƒŠã«3306ãƒãƒ¼ãƒˆçµŒç”±ã§é€šä¿¡
      url      = &#34;jdbc:mysql://db:3306/twitter_clone?useSSL=false&#34;,
      # docker-composeã§æŒ‡å®šã—ãŸã‚‚ã®ã¨åˆã‚ã›ã‚‹
      user     = &#34;root&#34;,
      password = &#34;root&#34;,
    }
  }
}
</code></pre>
<h3 is-upgraded>è¨­å®šã®è£œè¶³</h3>
<p>å…ˆã»ã©è¿½åŠ ã—ãŸè¨­å®šã‚’ç°¡å˜ã«èª¬æ˜ã—ã¾ã™ã€‚</p>
<p>slickã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã®å‚ç…§è¨­å®šã¯<code>slick.dbs.{db_name}.db</code> ã¨ã„ã†ã‚ˆã†ãªæ§‹é€ ã«ãªã£ã¦ãŠã‚Šã€<code>db_name</code>ã®éƒ¨åˆ†ã¯ä»»æ„ã«è¨­å®šå¯èƒ½ã§ã™ã€‚<br> ã“ã“ã§è¨­å®šã—ãŸ<code>db_name</code>ãŒã“ã®ã‚·ã‚¹ãƒ†ãƒ å†…ã§ã®å¯¾è±¡DBã®åç§°ã¨ãªã‚Šã¾ã™ã€‚<br> ä»Šå›ã¯æ…£ç¿’ã«å€£ã„<code>default</code>ã¨ã—ã¾ã—ãŸãŒ<code>twitter_clone</code>ã‚„<code>master</code>, <code>slave</code>ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p>
<p><code>url</code>ã®ä¸­ã§<code>db:3306</code>ã¨ã„ã†ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®<code>db</code>ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§ã®hoståã«ãªã‚Šã¾ã™ã€‚<br><code>docker-compose.yaml</code>ã§DBå´ã®ã‚³ãƒ³ãƒ†ãƒŠã®ã‚³ãƒ³ãƒ†ãƒŠåã‚’<code>db</code>ã¨ã—ã¦ã„ã‚‹ã®ã§ã€ãã®ã‚³ãƒ³ãƒ†ãƒŠåã§å¯¾è±¡ã®ã‚µãƒ¼ãƒã¸ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã—ã¦ã„ã¾ã™ã€‚</p>
<h2 is-upgraded>Migrationç”¨ã®sqlã‚’ä½œæˆ</h2>
<p>DBæ¥ç¶šã®è¨­å®šãŒã§ããŸã®ã§ã€æ¬¡ã¯DBã«å¯¾ã—ã¦å®Ÿè¡Œã™ã‚‹SQLã‚’ç”¨æ„ã—ã¾ã™ã€‚<br> evolutionsã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§<code>conf/evolutions/{db_name}/{é€£</code>ç•ª}.sqlã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã«ã„ãã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ã§ãƒ•ã‚©ãƒ«ãƒ€/ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>conf
â””â”€â”€ evolutions
    â””â”€â”€ default
        â””â”€â”€ 1.sql
</code></pre>
<p>1.sqlã¯ä¸€æ—¦ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢ã§è¨˜è¼‰ã—ã¦ã€å‹•ä½œã‚’ç¢ºèªã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>-- Tweet schema

-- !Ups
CREATE TABLE tweet (
    id      bigint(20)    NOT NULL AUTO_INCREMENT,
    content varchar(120)  NOT NULL,
    -- created_at timestamp NOT NULL,
    -- updated_at timestamp NOT NULL
    PRIMARY KEY (id)
);

-- !Downs
DROP TABLE tweet;
</code></pre>
<p>slickã§æ—¥ä»˜å‘¨ã‚Šã®è¨­å®šã‚’ã™ã‚‹ã®ãŒå°‘ã—é¢å€’ãªã®ã§ã€ã“ã“ã§ã¯ä¸€æ—¦timestampã®è¨­å®šã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ã„ã¾ã™ã€‚<br> æœ€çµ‚çš„ã«ã¯è¨­å®šã—ã¦ã„ãã®ã§ã”å®‰å¿ƒãã ã•ã„ã€‚</p>
<h2 is-upgraded>evolutionsã‚’å®Ÿè¡Œ</h2>
<p>æº–å‚™ãŒå®Œäº†ã—ãŸã®ã§ã€å®Ÿéš›ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚<br> evolutionsã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ä½œã‚Šã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ docker-compose exec play-scala bash
/source# sbt run
</code></pre>
<p>ã‚µãƒ¼ãƒãŒèµ·å‹•ã§ããŸã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰Playã¸<a href="http://localhost:9000" target="_blank">ã‚¢ã‚¯ã‚»ã‚¹</a>ã—ã¾ã™ã€‚</p>
<p>ãã†ã™ã‚‹ã¨ä»¥ä¸‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 450.00px" src="img/62272463c752f4e8.png"></p>
<p>ã“ã®ç”»é¢ã®<code>Apply this script now!</code>ãƒœã‚¿ãƒ³ã‹ã‚‰ã€evolutionsã®å®Ÿè¡Œã‚’è¨±å¯ã—ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ°ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br> å®Ÿéš›ã«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å®Ÿè¡Œã‚’ã—ã¦ã¿ãŸã‚‰ã€mysqlå´ã®ã‚³ãƒ³ãƒ†ãƒŠã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>$ docker-compose exec db bash
/# mysql -u root -proot
mysql&gt; use twitter_clone
mysql&gt; show tables; 
# +-------------------------+
# | Tables_in_twitter_clone |
# +-------------------------+
# | play_evolutions         |
# | tweet                   |
# +-------------------------+
# 2 rows in set (0.01 sec)
</code></pre>
<p>ã“ã®ã‚ˆã†ã«<code>tweet</code>ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ãŸã‚‰ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æˆåŠŸã§ã™ã€‚<br> ä¸€ç·’ã«ä½œæˆã•ã‚Œã¦ã„ã‚‹<code>play_evolutions</code>ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€evolutionså´ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡ŒçŠ¶æ³ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãªã‚Šã¾ã™ã€‚<br> ç‰¹ã«æ°—ã«ã—ãªãã¦å¤§ä¸ˆå¤«ã§ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="slick-codegenã§slickã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ" duration="0">
        <p>slick-codegenã¨ã„ã†ã®ã¯DBã®tableæƒ…å ±ã‹ã‚‰slickã§åˆ©ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚<br> codegeã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®è‡ªå‹•å®Ÿè¡Œã¨sbt commandã«ç™»éŒ²ã—ã¦ã®æ‰‹å‹•å®Ÿè¡Œãªã©ã€ã„ãã¤ã‹ã®å®Ÿè¡Œæ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚<br> ä»Šå›ã¯sbt taskã¨ã—ã¦ç™»éŒ²ã—ã¦æ‰‹å‹•å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ãã¾ã™ãŒã€sbtã«ã¤ã„ã¦ã¯è©³ã—ãçŸ¥ã‚‰ãªã„ãŸã‚ã€è¨­å®šæ–¹æ³•ã®ã¿è¨˜è¿°ã—è©³ç´°ã«ã¤ã„ã¦ã¯å‰²æ„›ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚</p>
<h2 is-upgraded>sbt taskã®ä½œæˆ</h2>
<p>ã¾ãšã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’<code>build.sbt</code>ã¸è¿½åŠ ã—ã¾ã™ã€‚</p>
<pre><code>// add code generation task
lazy val slickCodeGen = taskKey[Unit](&#34;execute Slick CodeGen&#34;)
slickCodeGen         := (runMain in Compile).toTask(&#34; com.example.SlickCodeGen&#34;).value
</code></pre>
<p>1è¡Œç›®ã§<code>slickCodeGen</code>ã¨ã„ã†åå‰ã§ã‚³ãƒãƒ³ãƒ‰(Task)ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚<br> 2è¡Œç›®ã§ã¯ãã®ã‚¿ã‚¹ã‚¯åã«å¯¾ã—ã¦ã€ç‰¹å®šã®ã‚¯ãƒ©ã‚¹å‡¦ç†ã‚’ç™»éŒ²ã™ã‚‹ã‚ˆã†ãªã“ã¨ã‚’ã—ã¦ã„ã¾ã™ã€‚â€» è©³ç´°ã¯ç†è§£ã§ãã¦ã„ã¾ã›ã‚“ã€‚<br> sbtã§ã¯<code>:=</code>ã‚’æ¼”ç®—å­ã‚’åˆ©ç”¨ã—ã¦Keyã«å¯¾ã—ã¦ã®å®Ÿæ…‹ã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚</p>
<p>ã“ã“ã§ã¯<code>com.example.SlickCodeGen</code>ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™ã­ã€‚<br> ãã®ãŸã‚ã“ã‚Œã‹ã‚‰ã€ã“ã®åå‰ã«ä¸€è‡´ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚</p>
<p>ã¾ãŸ<code>toTask()</code>ã«æ¸¡ã™ã¨ãã«ã€å…ˆé ­ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ãŒã€ã“ã‚ŒãŒãªã„ã¨æ­£å¸¸ã«ãƒ•ã‚¡ã‚¤ãƒ«ã®å‘¼ã³å‡ºã—ãŒè¡Œãˆã¾ã›ã‚“ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚</p>
<h2 is-upgraded>SlickCodeGenã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹</h2>
<p>ãã‚Œã§ã¯æ—©é€ŸSlickCodeGenã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚<br> ä»Šå›ã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ /å¤‰æ›´ã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚</p>
<ul>
<li>app/tasks/SlickCodeGen.scala</li>
<li>build.sbt</li>
<li>conf/application.conf</li>
</ul>
<p><code>app/tasks/SlickCodeGen.scala</code></p>
<pre><code>// Taskã«ç™»éŒ²ã—ãŸã‚‚ã®ã¨åŒæ§˜ã«packageã‚’æŒ‡å®š
package com.example

import com.typesafe.config.ConfigFactory
import slick.codegen.SourceCodeGenerator

object SlickCodeGen extends App {
  // typesafe configã‚’åˆ©ç”¨ã—ã¦application.confã‚’ãƒ­ãƒ¼ãƒ‰
  val config      = ConfigFactory.load()
  val defaultPath = &#34;slick.dbs.default&#34;

  // æœ«å°¾ã®$ã‚’å‰Šé™¤
  // sè£œé–“å­ã¤ãæ–‡å­—åˆ—ã§ã¯${}. $hogeã§å¤‰æ•°ã‚’å‚ç…§å¯èƒ½ã§ã™ã€‚ã“ã®å ´åˆ slick.dbs.default.profileã®ã‚ˆã†ã«å±•é–‹ã•ã‚Œã¾ã™ã€‚
  val profile   = config.getString(s&#34;$defaultPath.profile&#34;).dropRight(1)
  val driver    = config.getString(s&#34;$defaultPath.db.driver&#34;)
  val url       = config.getString(s&#34;$defaultPath.db.url&#34;)
  val user      = config.getString(s&#34;$defaultPath.db.user&#34;)
  val password  = config.getString(s&#34;$defaultPath.db.password&#34;)

  // pathãŒåˆ¥ãªã®ã§ç›´æ¥å‘¼ã³å‡ºã—
  val outputDir = config.getString(&#34;slick.codegen.outputDir&#34;)
  val pkg       = config.getString(&#34;application.package&#34;)

  // slick-codegenã‚’å®Ÿè¡Œ
  SourceCodeGenerator.main(
    Array(profile, driver, url, outputDir, pkg, user, password)
  )
}
</code></pre>
<p>ã“ã“ã§<code>TypesafeConfig</code>ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã¯å¤–éƒ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ãªã‚‹ãŸã‚<code>build.sbt</code>ã¸ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>
<p><code>build.sbt</code></p>
<pre><code>&#34;com.typesafe&#34; % &#34;config&#34; % &#34;1.4.0&#34;
</code></pre>
<p>ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã—ãŸã‚‰ã€<code>SlickCodeGen</code>ã‚¯ãƒ©ã‚¹ã§åˆ©ç”¨ã—ã¦ã„ã‚‹è¨­å®šæƒ…å ±ã‚’<code>application.conf</code>ã¸è¿½è¨˜ã—ã¦ã„ãã¾ã™ã€‚</p>
<pre><code>slick {
  # slick.dbsã‚’slickã¨dbsã«åˆ†é›¢ã—ã¦ã„ã‚‹ã®ã§æ³¨æ„
  dbs {
    default {
      profile = &#34;slick.jdbc.MySQLProfile$&#34;

      db {
        driver   = com.mysql.cj.jdbc.Driver,
        url      = &#34;jdbc:mysql://db:3306/twitter_clone?useSSL=false&#34;,
        user     = &#34;root&#34;,
        password = &#34;root&#34;,
      }
    }
  }
  codegen {
    # ã“ã“ã§ã®.ã¯root directoryã¨ãªã‚‹
    outputDir = &#34;./output/codegen&#34;
  }
}

# DBé–¢ä¿‚ãªãã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ã®è¨­å®šã®ãŸã‚slickã®å¤–ã«å®šç¾©ã—ã¦ã„ã¾ã™
application {
  package = &#34;com.example&#34;
}
</code></pre>
<p>slickéƒ¨åˆ†ã®æ§‹é€ ãŒå°‘ã—å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã®ã§æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚</p>
<h3 is-upgraded>TypesafeConfigå°å…¥ã®è£œè¶³</h3>
<p>é€šå¸¸ã®playã§ã¯configã¯Controllerã¸ã®DIã‹ã‚‰åˆ©ç”¨ã™ã‚‹ãŸã‚ã€ç›´æ¥ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ã¯ã‚ã¾ã‚Šå¾¡è¡Œå„€ãŒè‰¯ã„ã‚‚ã®ã§ã¯ãªã„ã®ã§ã™ãŒã€ãƒãƒƒãƒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§Controllerã‚’çµŒç”±ã§ããªã„ã“ã¨ã‚„ã€ãã‚“ãªã«ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ã‚‚ãªã„ã®ã§ç›´æ¥å–ã‚Šå‡ºã™ã“ã¨ã‚’é¸æŠã—ã¦ã„ã¾ã™ã€‚</p>
<h2 is-upgraded>SlickCodeGen Taskã®å®Ÿè¡Œ</h2>
<p>ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£ãŒã§ããŸã‚‰ã€æ—©é€Ÿã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>$ docker-compose exec play-scala bash
/source# sbt slickCodeGen
</code></pre>
<p>ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã«æˆåŠŸã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«<code>Tables.scala</code>ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚</p>
<pre><code>output
â””â”€â”€ codegen
    â””â”€â”€ com
        â””â”€â”€ example
            â””â”€â”€ Tables.scala
</code></pre>
<p>ä»Šå›ã¯evolutionsã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚å¯¾è±¡ã«å–ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‹ãªã‚Š<code>ã</code>†ã‚ã£...ã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ãŒã€Tweetéƒ¨åˆ†ã«é™ã‚Œã°ä»¥ä¸‹ã®éƒ¨åˆ†ã ã‘ã§ã™ã€‚</p>
<p><code>output/codegen/com/example/Tables.scala</code></p>
<pre><code>  implicit def GetResultTweetRow(implicit e0: GR[Long], e1: GR[String]): GR[TweetRow] = GR{
    prs =&gt; import prs._
    TweetRow.tupled((&lt;&lt;[Long], &lt;&lt;[String]))
  }

  class Tweet(_tableTag: Tag) extends profile.api.Table[TweetRow](_tableTag, Some(&#34;twitter_clone&#34;), &#34;tweet&#34;) {
    def * = (id, content) &lt;&gt; (TweetRow.tupled, TweetRow.unapply)
    def ? = ((Rep.Some(id), Rep.Some(content))).shaped.&lt;&gt;({r=&gt;import r._; _1.map(_=&gt; TweetRow.tupled((_1.get, _2.get)))}, (_:Any) =&gt;  throw new Exception(&#34;Inserting into ? projection not supported.&#34;))

    val id: Rep[Long] = column[Long](&#34;id&#34;, O.AutoInc, O.PrimaryKey)
    val content: Rep[String] = column[String](&#34;content&#34;, O.Length(120,varying=true))
  }

  lazy val Tweet = new TableQuery(tag =&gt; new Tweet(tag))
</code></pre>
<p><code>Slick</code>ã¯è©³ç´°ã‚’ç†è§£ã—ã‚ˆã†ã¨ã™ã‚‹ã¨å¤§å¤‰ãªã®ã§ã“ã“ã§ã¯è©³ç´°ã¯çœãã¾ã™ãŒã€ã“ã‚Œã§Slickã‹ã‚‰Tweetãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ“ä½œã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚³ãƒ¼ãƒ‰ãŒç”¨æ„ã§ãã¾ã—ãŸã€‚<br> ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªåŠ›ã§å®Ÿè£…ã™ã‚‹ã®ã¯ãƒŸã‚¹ã‚‚ç™ºç”Ÿã—ã¦å¤§å¤‰ãªã®ã§ã€ç‰¹ã«æ…£ã‚Œãªã„ã†ã¡ã¯codegenã‹ã‚‰ç”Ÿæˆã™ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="slick-codegenã®æ—¥ä»˜å‹Mappingã®å¤‰æ›´" duration="0">
        <p>slick-codegenã§ã¯Timestampã‚„Datetimeã‚’<code>java.sql.Timestamp</code>ã«Mappingã—ã¦ã„ã¾ã™ã€‚<br> ã“ã®ã¾ã¾ã ã¨ä½¿ã„ã¥ã‚‰ã„ã®ã§<code>java.time.LocalDateTime</code>ã§ãƒ¢ãƒ‡ãƒ«ç”ŸæˆãŒè¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«codegenã®è¨­å®šã‚’å¤‰æ›´ã—ã¦ã„ãã¾ã™ã€‚</p>
<h2 is-upgraded>evolutionsã®sqlã«æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ </h2>
<p>ã¾ãšã¯<code>conf/evolutions/default/1.sql</code>ã‚’ä¿®æ­£ã—ã¦ãã¾ã™ã€‚<br> æ—¥ä»˜é–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ãªã‹ã£ãŸã®ã§ã€ã‚ˆãã‚ã‚‹æ—¥ä»˜å‹ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚<br> ã¤ã„ã§ã«ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚</p>
<pre><code>-- Tweet schema

-- !Ups
CREATE TABLE tweet (
    id         BIGINT(20)    NOT NULL AUTO_INCREMENT,
    content    VARCHAR(120)  NOT NULL,
    posted_at  DATETIME      NOT NULL,
    created_at TIMESTAMP(6)  NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
    updated_at TIMESTAMP(6)  NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
    PRIMARY KEY (id)
);

-- sample data
INSERT INTO tweet(id, content, posted_at) VALUES
(1, &#39;tweet1&#39;, &#39;2020-03-15 13:15:00.012345&#39;),
(2, &#39;tweet2&#39;, &#39;2020-03-15 14:15:00.012345&#39;),
(3, &#39;tweet3&#39;, &#39;2020-03-15 15:15:00.012345&#39;),
(4, &#39;tweet4&#39;, &#39;2020-03-15 16:15:00.012345&#39;),
(5, &#39;tweet5&#39;, &#39;2020-03-15 17:15:00.012345&#39;);

-- !Downs
DROP TABLE tweet;
</code></pre>
<p>ã“ã“ã§å¤‰æ›´ã—ãŸã‚‚ã®ã¯ã€æ”¹ã‚ã¦<code>sbt run</code>ã§èµ·å‹•ã—ãŸã‚µãƒ¼ãƒã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œãˆã°ã€æœ€åˆã¨åŒã˜ã‚ˆã†ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å®Ÿè¡ŒãŒå¯èƒ½ã§ã™ã€‚</p>
<h2 is-upgraded>SlickCodeGenã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¿®æ­£</h2>
<p>ä»Šåº¦ã¯SQLã«åˆã‚ã›ã¦ã€SlickCodeGené–¢é€£ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚<br> ä»Šå›ä¿®æ­£ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹</p>
<ul>
<li>[Rename]: app/tasks/SlickCodeGen.scala -&gt; app/tasks/CustomSlickCodeGen.scala</li>
<li>build.sbt</li>
</ul>
<p><code>app/tasks/CustomSlickCodeGen.scala</code></p>
<pre><code>package com.example

import com.typesafe.config.ConfigFactory
import slick.codegen.SourceCodeGenerator
import slick.jdbc.MySQLProfile
import slick.jdbc.MySQLProfile.api.Database
import java.time.LocalDateTime
import scala.concurrent.ExecutionContext.Implicits.global
import scala.util.{Success, Failure}
import scala.concurrent.Await
import scala.concurrent.duration.Duration

// objectåã¯å¤‰æ›´
object CustomSlickCodeGen extends App {
  // typesafe configã‚’åˆ©ç”¨ã—ã¦application.confã‚’ãƒ­ãƒ¼ãƒ‰
  val config      = ConfigFactory.load()
  val defaultPath = &#34;slick.dbs.default&#34;

  // æœ«å°¾ã®$ã‚’å‰Šé™¤
  val profile   = config.getString(s&#34;$defaultPath.profile&#34;).dropRight(1)
  val driver    = config.getString(s&#34;$defaultPath.db.driver&#34;)
  val url       = config.getString(s&#34;$defaultPath.db.url&#34;)
  val user      = config.getString(s&#34;$defaultPath.db.user&#34;)
  val password  = config.getString(s&#34;$defaultPath.db.password&#34;)

  // pathãŒåˆ¥ãªã®ã§ç›´æ¥å‘¼ã³å‡ºã—
  val outputDir = config.getString(&#34;slick.codegen.outputDir&#34;)
  val pkg       = config.getString(&#34;application.package&#34;)

  // dbæ¥ç¶šç”¨ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
  val db  = Database.forURL(
    url      = this.url,
    driver   = this.driver,
    user     = this.user,
    password = this.password
  )

  // evolutionsç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å¯¾è±¡ã‹ã‚‰å¤–ã™
  val ignoreTables        = Seq(&#34;play_evolutions&#34;)
  val codegenTargetTables = MySQLProfile.createModel(Some(
    MySQLProfile.defaultTables.map(
      _.filter(table =&gt; !ignoreTables.contains(table.name.name.toLowerCase))
    )
  ))

  // ãƒ¢ãƒ‡ãƒ«ã‚’ç”Ÿæˆã—ãŸã„å¯¾è±¡ã‚’æ¸¡ã™
  val modelFuture = db.run(codegenTargetTables)

  // CustomCodeGeneratorã‚’ç”Ÿæˆã—ã¤ã¤ã€writeToFileã§æ›¸ãå‡ºã™
  val codegenFuture = modelFuture.map(model =&gt; new SourceCodeGenerator(model) {
    // LocalDateTimeã®importã‚’è¿½åŠ 
    override def code = &#34;import java.time.{LocalDateTime}&#34; + &#34;\n&#34; + super.code

    // override table generator
    override def Table = new Table(_){
      // disable entity class generation for tables with more than 22 columns
      override def hugeClassEnabled = false

      override def Column = new Column(_){
        // datetimeã¯ãƒ‡ãƒ•ã‚¡ã‚ªãƒ«ãƒˆã§java.sql.Timestampå‹ã«ãªã‚‹ã®ã§ã€LocalDateTimeã«æ›¸ãæ›ãˆ
        override def rawType = model.tpe match {
          case &#34;java.sql.Timestamp&#34; =&gt; &#34;LocalDateTime&#34;
          case _                    =&gt; super.rawType
        }
      }
    }
  }.writeToFile(profile, outputDir, pkg))

  // å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤
  Await.result(codegenFuture, Duration.Inf)
}

</code></pre>
<pre><code>// -- build.sbt: slickCodeGenã‚³ãƒãƒ³ãƒ‰ã«ç´ã¥ã‘ã‚‹ã‚¯ãƒ©ã‚¹ã®å¤‰æ›´
slickCodeGen         := (runMain in Compile).toTask(&#34; com.example.CustomSlickCodeGen&#34;).value
</code></pre>
<p>ä»Šå›ã®ä¿®æ­£ã¯ã‚„ã‚„è¤‡é›‘ã«ãªã£ã¦ã„ã¾ã™ã­ã€‚<br> ã„ã‚ã„ã‚ã¨å®Ÿè£…ãŒå…¥ã£ã¦ã„ã¾ã™ãŒã€æ³¨ç›®ã™ã¹ããƒã‚¤ãƒ³ãƒˆã¯1ç‚¹ã¨ãŠã¾ã‘1ã¤ã§ã™ã€‚</p>
<h3 is-upgraded>Codegenã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹æ—¥ä»˜å‹ã®å‹ã‚’å¤‰æ›´</h3>
<p>æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã®ç›®çš„ã§ã‚ã‚‹æ—¥ä»˜å‹ã®å¤‰æ›ã‚’ã—ã¦ã„ã‚‹éƒ¨åˆ†ã¯ã“ã“ã§ã™ã€‚</p>
<pre><code>override def Column = new Column(_){
  // datetimeã¯ãƒ‡ãƒ•ã‚¡ãƒ«ãƒˆã§java.sql.Timestampå‹ã«ãªã‚‹ã®ã§ã€LocalDateTimeã«æ›¸ãæ›ãˆ
  override def rawType = model.tpe match {
    case &#34;java.sql.Timestamp&#34; =&gt; &#34;LocalDateTime&#34;
    case _                    =&gt; super.rawType
  }
}
</code></pre>
<p>ã“ã“ã§Columnå®šç¾©ã®å®Ÿè£…ã‚’overrideã—ã¦å·®ã—æ›¿ãˆã¦ã„ã¾ã™ã€‚<br> ä»Šå›ã¯modelã®å‹ã‚’caseã§ãƒã‚§ãƒƒã‚¯ã—ã¦<code>java.sql.Timestamp</code>ã®ã¨ãã«<code>LocalDateTime</code>ã«ãªã‚‹ã‚ˆã†ã«å¤‰æ›´ã‚’ã‹ã‘ã¦ã„ã¾ã™ã­ã€‚</p>
<p>æ–‡å­—åˆ—ã§æŒ‡å®šã—ã¦ã„ã¾ã™ãŒã€çµå±€Codegenã§ã¯<code>.scala</code>ã®æ‹¡å¼µå­ã‚’æŒã¤ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ã¦ã„ã‚‹ã ã‘ãªã®ã§ã€æœ€çµ‚æˆæœç‰©ã§ã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆä¸Šã§å‡ºåŠ›ã•ã‚Œã¦æ¬²ã—ã„æ–‡å­—åˆ—ã«ç½®ãæ›ãˆã¦ã‚ã’ã‚Œã°è‰¯ã„ã§ã™ã€‚</p>
<p>ã¡ãªã¿ã«ã€ã“ã®ã¾ã¾ã§ã¯importãŒä¸æ˜ç¢ºã§å®Ÿéš›ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰åˆ©ç”¨ã™ã‚‹ã¨ãã«ã¯LocalDateTimeãŒè¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã€‚<br> ãã®ãŸã‚ã€ãã®å°‘ã—å‰ã®éƒ¨åˆ†ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦importæ–‡ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚</p>
<pre><code>// LocalDateTimeã®importã‚’è¿½åŠ 
override def code = &#34;import java.time.{LocalDateTime}&#34; + &#34;\n&#34; + super.code
</code></pre>
<p>ã“ã‚Œã¯æœ€çµ‚çš„ãªå‡ºåŠ›ã‚³ãƒ¼ãƒ‰ã®å…ˆé ­ã«importã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã‚ˆã†ãªå‹•ãã«ãªã‚Šã¾ã™ã€‚</p>
<h3 is-upgraded>ãŠã¾ã‘ã®éƒ¨åˆ†</h3>
<p>ã“ã‚Œã¯ãŠã¾ã‘ãªã®ã§ã€èª¬æ˜ã¯çœç•¥ã—ã¾ã™ãŒä»¥ä¸‹ã®éƒ¨åˆ†ã§evolutionsç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ¢ãƒ‡ãƒ«ä½œæˆå¯¾è±¡ã‹ã‚‰å¤–ã—ã¦ã„ã¾ã™ã€‚</p>
<pre><code>// evolutionsç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å¯¾è±¡ã‹ã‚‰å¤–ã™
val ignoreTables        = Seq(&#34;play_evolutions&#34;)
val codegenTargetTables = MySQLProfile.createModel(Some(
  MySQLProfile.defaultTables.map(
    _.filter(table =&gt; !ignoreTables.contains(table.name.name.toLowerCase))
  )
))
</code></pre>
<p>ã“ã‚Œã§evolutionsãŒå¯¾è±¡ã‹ã‚‰å¤–ã‚Œã¦ã€å°‘ã—è¦‹ã‚„ã™ããªã‚Šã¾ã—ãŸã­ã€‚</p>
<h2 is-upgraded>slick-codegenã®å®Ÿè¡Œã¨å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª</h2>
<p>è¨­å®šãŒã§ããŸã®ã§ã€æ”¹ã‚ã¦slick-codegenã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code># ä»Šå›ã¯ä»Šã¾ã§ã¨é•ã†å½¢ã§å®Ÿè¡Œã€‚
$ docker-compose exec play-scala sbt slickCodeGen
</code></pre>
<p>å®Ÿè¡Œå¾Œã«å‡ºåŠ›ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ãŒã“ã¡ã‚‰</p>
<p><code>output/codegen/com/example/Tables.scala</code></p>
<pre><code>// ... çœç•¥
import java.time.{LocalDateTime}
// ... çœç•¥
/** Database column posted_at SqlType(DATETIME) */
val postedAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;posted_at&#34;)
/** Database column created_at SqlType(DATETIME) */
val createdAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;created_at&#34;)
/** Database column updated_at SqlType(DATETIME) */
val updatedAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;updated_at&#34;)
</code></pre>
<p>ã¡ã‚ƒã‚“ã¨LocalDateTimeã«ãªã£ã¦ã„ã¾ã™ã­ã€‚<br> é•·ããªã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€ã“ã‚Œã§slick-codegenå´ã®è¨­å®šã¯ä¸€æ—¦å®Œäº†ã«ãªã‚Šã¾ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="slickã®ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè£…" duration="0">
        <p>åŸºæœ¬çš„ãªslickã®è¨­å®šãŒå®Œäº†ã—ãŸã®ã§ã€evolutionsã§ä½œæˆã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãªã©ã‚’åˆ©ç”¨ã—ãªãŒã‚‰å®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã§åˆ©ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¦ãã¾ã™ã€‚<br> å®Ÿè£…æ–¹æ³•ãŒä½•ç¨®é¡ã‹ã‚ã‚‹ã®ã§ã™ãŒã€åˆ©ç”¨ã—ã¦ã‚‹RDBã«å¿œã˜ã¦å°‘ã—å¯¾å¿œæ–¹æ³•ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚<br> ä»Šå›ã¯MySQLã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ãã‚Œå‰æã§è¨˜è¼‰ã—ã¦ã„ãã¾ã™ã€‚</p>
<h2 is-upgraded>Slick3.3ã¨MySQLã‚’çµ„ã¿åˆã‚ã›ãŸå ´åˆã®æ—¥ä»˜å‹å¯¾å¿œ</h2>
<p>Slickã¯RDBã”ã¨ã«æ—¥ä»˜é–¢é€£ã‚’æ‰±ã†ã¨ãã«åˆ©ç”¨ã™ã‚‹å‹ãŒé•ã£ã¦ã„ã¾ã™ã€‚<br> ç‰¹ã«MySQLã¯ã»ã¼å…¨ã¦æ–‡å­—åˆ—ã¨ã—ã¦å–ã‚Šæ‰±ãŠã†ã¨ã™ã‚‹ãŸã‚ã€ãã®ã¾ã¾ã®çŠ¶æ…‹ã§ã¯åˆ©ç”¨ã—ã¥ã‚‰ããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚<br> ä»Šå›ã¯ã“ã®éƒ¨åˆ†ã‚’è‡ªå‰ã®è¿½åŠ å®Ÿè£…ã§å¸åã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚<br> å¯¾å¿œæ–¹æ³•ã¯ä½•ç¨®é¡ã‹ã‚ã‚‹ã®ã§ã™ãŒã€ä»Šå›ã¯ãã®ã†ã¡æ¡ç”¨ã—ã¦ã„ãæ–¹æ³•ã®å®Ÿè£…ã®ã¿è¡Œã„ã¾ã™ã€‚<br> ãŠã¾ã‘éƒ¨åˆ†ã§ä»–ã®å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦ã‚‚ç´¹ä»‹ã—ã¾ã™ã®ã§ã€æ°—ã«ãªã‚‹æ–¹ã¯ãŠã¾ã‘ã‚’ã”è¦§ãã ã•ã„ã€‚</p>
<h3 is-upgraded>æ—¥ä»˜é–¢é€£ã®RDBã”ã¨æ¯”è¼ƒ</h3>
<p>RDBã”ã¨ã«é•ã†ã¨ã‚ã‚Šã¾ã—ãŸãŒã€å®Ÿéš›ã«ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚<br> ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å…¬å¼ã‚µã‚¤ãƒˆã®æƒ…å ±ãŒç¢ºèªã§ãã¾ã™ãŒã€ãƒªãƒ³ã‚¯å…ˆã®æƒ…å ±ã®ç”»åƒã‚‚åˆã‚ã›ã¦è¼‰ã›ã¦ãŠãã¾ã™ã€‚<br><a href="https://scala-slick.org/doc/3.3.1/upgrade.html#support-for-java.time-columns" target="_blank">https://scala-slick.org/doc/3.3.1/upgrade.html#support-for-java.time-columns</a></p>
<p>[MySQLã®å ´åˆ]<br><img style="width: 450.00px" src="img/2f223420ddf9da7e.png"></p>
<p>[Postgresã®å ´åˆ]<br><img style="width: 450.00px" src="img/9996ffda560c6db3.png"></p>
<p>[Oracleã®å ´åˆ] <img style="width: 450.00px" src="img/c3db0174fe60d924.png"></p>
<p>ã“ã®ã‚ˆã†ã«ãã‚Œãã‚Œæ—¥ä»˜å‹ã®å‹ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸSQL Typeã«å·®ãŒã‚ã‚Šã¾ã™ã€‚<br> ç´°ã‹ã„ã“ã¨ã¯ä¸æ˜ã§ã™ãŒå³å¯†ã«ã‚„ã‚ã†ã¨ã™ã‚‹ã¨MySQLãŒæ—¥ä»˜é–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã®æŒã¡æ–¹ã«æŒ¯ã‚Œå¹…ãŒå¤§ããã¦parserãŒçµ±ä¸€ã§ããªã‹ã£ãŸã®ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã­ã€‚ (ã‚ã‹ã‚Šã¾ã›ã‚“ãŒ)</p>
<h2 is-upgraded>æœªå¯¾å¿œã®å ´åˆã®ã‚¨ãƒ©ãƒ¼ã¨åŸå› </h2>
<p>ç‰¹ã«ä½•ã‚‚å¯¾å¿œã›ãšã«ä»Šã®ã¾ã¾ã®çŠ¶æ…‹ã§å®Ÿè£…ã‚’é€²ã‚ã‚‹ã¨DBã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œãªã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚</p>
<pre><code>play.api.http.HttpErrorHandlerExceptions$$anon$1: Execution exception[[DateTimeParseException: Text &#39;2020-03-15 13:15:00&#39; could not be parsed at index 10]]
        at play.api.http.HttpErrorHandlerExceptions$.throwableToUsefulException(HttpErrorHandler.scala:332)
        at play.api.http.DefaultHttpErrorHandler.onServerError(HttpErrorHandler.scala:251)
        at play.core.server.AkkaHttpServer$$anonfun$2.applyOrElse(AkkaHttpServer.scala:421)
        at play.core.server.AkkaHttpServer$$anonfun$2.applyOrElse(AkkaHttpServer.scala:417)
        at scala.concurrent.impl.Promise$Transformation.run(Promise.scala:453)
        at akka.dispatch.BatchingExecutor$AbstractBatch.processBatch(BatchingExecutor.scala:55)
        at akka.dispatch.BatchingExecutor$BlockableBatch.$anonfun$run$1(BatchingExecutor.scala:92)
        at scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
        at scala.concurrent.BlockContext$.withBlockContext(BlockContext.scala:94)
        at akka.dispatch.BatchingExecutor$BlockableBatch.run(BatchingExecutor.scala:92)
Caused by: java.time.format.DateTimeParseException: Text &#39;2020-03-15 13:15:00&#39; could not be parsed at index 10
        at java.time.format.DateTimeFormatter.parseResolved0(DateTimeFormatter.java:1949)
        at java.time.format.DateTimeFormatter.parse(DateTimeFormatter.java:1851)
        at java.time.LocalDateTime.parse(LocalDateTime.java:492)
        at java.time.LocalDateTime.parse(LocalDateTime.java:477)
        at slick.jdbc.MySQLProfile$JdbcTypes$$anon$4.getValue(MySQLProfile.scala:404)
        at slick.jdbc.MySQLProfile$JdbcTypes$$anon$4.getValue(MySQLProfile.scala:389)
        at slick.jdbc.SpecializedJdbcResultConverter$$anon$1.read(SpecializedJdbcResultConverters.scala:26)
        at slick.jdbc.SpecializedJdbcResultConverter$$anon$1.read(SpecializedJdbcResultConverters.scala:24)
        at slick.relational.ProductResultConverter.read(ResultConverter.scala:54)
        at slick.relational.ProductResultConverter.read(ResultConverter.scala:44)
</code></pre>
<p>é‡è¦ãªéƒ¨åˆ†ã¯ä»¥ä¸‹ã®éƒ¨åˆ†ã§ã™ã€‚<br><code>Execution exception[[DateTimeParseException: Text &#39;2020-03-15 13:15:00&#39; could not be parsed at index 10]]</code></p>
<p>æ—¥ä»˜å‹ã®parseã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã„ã¾ã™ã­ã€‚</p>
<p>ã“ã“ã‹ã‚‰å°‘ã—é›£ã—ããªã‚‹ã®ã§ã™ãŒã€ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’èª¿æŸ»ã—ã¦ã„ãã¾ã™ã€‚</p>
<p>ã‚¨ãƒ©ãƒ¼èª¿æŸ»ã®ãŸã‚ã«ã€å…ˆã»ã©ã®ãƒ­ã‚°ã‚’ã‚‚ã†å°‘ã—ç´°ã‹ãã¿ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br> ãã†ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚<br><code>at slick.jdbc.MySQLProfile$JdbcTypes$$anon$4.getValue(MySQLProfile.scala:389)</code></p>
<p>ã“ã‚ŒãŒä»Šå›ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ç®‡æ‰€ã§ã™ã€‚<br> ã“ã®<code>slic.jdbc.MySQLProfile</code>ãŒã©ã“ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€codegenã§è‡ªå‹•ç”Ÿæˆã—ãŸModelã«ã‚ã‚Šã¾ã™ã€‚</p>
<p>codegenã§ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«MySQLProfileã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒã‚ã‚Šã¾ã™ã­ã€‚</p>
<pre><code>object Tables extends {
  val profile = slick.jdbc.MySQLProfile
} with Tables
</code></pre>
<p>ã“ã“ã§èª­ã¿è¾¼ã‚“ã profileã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹LocalDateTimeã®<code>getValue</code>ã¨ã„ã†ã¨ã“ã‚ã«å•é¡ŒãŒã‚ã‚‹ã¨ã„ã†ã‚ã‘ã§ã™ã€‚</p>
<p>ã§ã¯ã€å¼•ãç¶šãã‚³ãƒ¼ãƒ‰ã‚’è¿½ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br> æ—©é€ŸMySQLProfileã®<code>getValue</code>ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚<br> ä»¥ä¸‹ãŒã€ãã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚</p>
<pre><code>    override val localDateTimeType : LocalDateTimeJdbcType = new LocalDateTimeJdbcType {
      override def sqlType : Int = {
        java.sql.Types.VARCHAR
      }
      override def setValue(v: LocalDateTime, p: PreparedStatement, idx: Int) : Unit = {
        p.setString(idx, if (v == null) null else v.toString)
      }
      // ä»Šå›ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã®ã¯ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰
      override def getValue(r: ResultSet, idx: Int) : LocalDateTime = {
        r.getString(idx) match {
          case null =&gt; null
          // å…·ä½“çš„ã«ã¯ã“ã® parse å‡¦ç†éƒ¨åˆ†ã§ã™ã€‚
          case iso8601String =&gt; LocalDateTime.parse(iso8601String)
        }
      }
      override def updateValue(v: LocalDateTime, r: ResultSet, idx: Int) = {
        r.updateString(idx, if (v == null) null else v.toString)
      }
      override def valueToSQLLiteral(value: LocalDateTime) : String = {
        stringToMySqlString(value.toString)
      }
    }
</code></pre>
<p>LocalDateTimeã®å€¤ã‚’<code>getValue</code>ã‚’è¦‹ã¦ãã ã•ã„ã€‚<br> ã“ã®ä¸­ã§DBã‹ã‚‰å—ã‘å–ã£ãŸæ—¥ä»˜ã®æ–‡å­—åˆ—ã‚’parseã—ã¦ã„ã¾ã™ã€‚<br> ä»Šå›ã¯ã“ã“ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã†ã¨ã„ã†ã“ã¨ãªã®ã§ã™ã€‚</p>
<p>LocalDateTime.parseã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯<code>yyyy-MM-ddTHH:mm:ss</code>ã¨ã„ã†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«åˆã‚ãªã„æ—¥ä»˜æ–‡å­—åˆ—ã¯å…¨ã¦parseã§è½ã¡ã¦ã—ã¾ã„ã¾ã™ã€‚<br> ä»Šå›ã®å ´åˆ<code>yyyy-MM-dd HH:mm:ss</code>ã®æ–‡å­—åˆ—ã§æ¸¡ã£ã¦ã—ã¾ã†ãŸã‚<code>T</code>ãŒè¶³ã‚Šã¦ãŠã‚‰ãšã€ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã‚ã‘ã§ã™ã­ã€‚<br> indexã‚‚ã¡ã‚‡ã†ã©10ç•ªç›®ã§ã™ã€‚</p>
<p>ã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã¨åŸå› ãŒã‚ã‹ã£ãŸã®ã§ã€æ¬¡ã¯ã“ã‚Œã‚’è§£æ±ºã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
<h2 is-upgraded>LocalDateTimeã®parseã‚¨ãƒ©ãƒ¼å¯¾å¿œæ–¹é‡æ±ºã‚</h2>
<p>ã“ã“ã§å¯¾å¿œæ–¹é‡ã‚’æ±ºã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> è©³ç´°ã¯ã“ã“ã§ã¯å‰²æ„›ã—ã¾ã™ãŒã€å¯¾å¿œæ–¹é‡ã¨ã—ã¦è€ƒãˆã‚‰ã‚Œã‚‹ã‚‚ã®ã¨ã—ã¦3ã¤ã»ã©ã‚ã‚Šã¾ã™ã€‚</p>
<ol type="1">
<li>ä¸€åº¦Stringã§å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¦Model &lt;-&gt; DB Valeã®å¤‰æ›ã‚’<code>def *</code>ãªã©ã§è‡ªå‰å®Ÿè£…ã™ã‚‹</li>
<li>MappedColumnTypeã‚’åˆ©ç”¨ã—ã¦ã€implict valã®å½¢ã§ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆã™ã‚‹</li>
<li>MySQLProfileã‚’ç¶™æ‰¿ã—ã¦ç‹¬è‡ªProfileã‚’ä½œæˆã™ã‚‹ (å…¬å¼æ¨å¥¨)</li>
</ol>
<p>ãã‚Œãã‚Œãƒ¡ãƒªãƒƒãƒˆ/ãƒ‡ãƒ¡ãƒªãƒƒãƒˆå‘ã„ã¦ã„ã‚‹ç”¨é€”ãªã©ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ï¼“ç•ªç›®ã®ç‹¬è‡ªProfileã‚’å®Ÿè£…ã™ã‚‹æ–¹å¼ã§å¯¾å¿œã‚’ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚</p>
<p>ã“ã®æ–¹æ³•ã‚’é¸æŠã™ã‚‹ç†ç”±ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«<code>å…</code>¬å¼æ¨å¥¨ã ã‹ã‚‰ã§ã™ã€‚<br> ç§ã¯ä¸€ç•ªç†è§£ã—ã‚„ã™ã„ã®ã¯1ç•ªã ã¨è€ƒãˆã¦ã„ã¦ã€ãã‚ŒãŒrookiesè³‡æ–™ã¨ã—ã¦ã¯é©åˆ‡ãªã®ã§ã¯ã¨æ‚©ã¿ã¾ã—ãŸã€‚<br> ãŸã ã€å…¨ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¢ãƒ‡ãƒ«ã®mappingã‚’æ›¸ã„ã¦ã„ãã®ã¯åŠ¹ç‡ãŒæ‚ªã™ãã‚‹ã®ã¨ã€å…¬å¼ãŒæ¨å¥¨ã™ã‚‹å½¢ãŒä¸€ç•ªå¾¡è¡Œå„€ãŒè‰¯ã„ã¨æ€ã†ã®ã§ã€Profileæ‹¡å¼µã§ä½œæˆã‚’ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚</p>
<p>ã¨ã¯ã„ãˆã€Profileæ‹¡å¼µã¨ã„ã†è¨€è‘‰ã®æŒã¤ãƒ‘ãƒ¯ãƒ¼ã®ã›ã„ã§é›£ã—ã„æ°—ãŒã™ã‚‹ã ã‘ã§ã€å®Ÿã¯<code>LocalDateTime.parse</code>ã®å¼•æ•°ã«æ¸¡ã™formatterã‚’å®Ÿè£…ã™ã‚‹ã ã‘ã¨ã„ã†è¶…ã‚·ãƒ³ãƒ—ãƒ«å¯¾å¿œã§ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> ã‚ã¾ã‚Šé›£ã—ãè€ƒãˆãšã«ã€Œæ—¢å­˜å®Ÿè£…ã‚³ãƒ”ãƒšã—ã¦LocalDateTimeã®formatterã ã‘ç›´ã™ã€ã¨æ€ã£ã¦ã„ãŸã ã‘ã‚Œã°ã€å¿ƒç†çš„è² è·ã¯æ¸›ã‚‹ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚</p>
<h2 is-upgraded>ç‹¬è‡ªProfileå®Ÿè£…</h2>
<p>ã§ã¯ã€ç‹¬è‡ªProfileã®å®Ÿè£…ã‚’ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚<br> å…ˆã»ã©ãŠè©±ã—ã—ãŸã‚ˆã†ã«å…¬å¼ã«å®Ÿè£…æ–¹æ³•ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã¡ã‚‰ã‚’å‚ç…§ã—ã¦ã„ãã¾ã™ã€‚<br><a href="https://scala-slick.org/doc/3.3.1/upgrade.html#support-for-java.time-columns" target="_blank">https://scala-slick.org/doc/3.3.1/upgrade.html#support-for-java.time-columns</a></p>
<p>æ–‡ç« ã§ã„ã†ã¨ä»¥ä¸‹ã®éƒ¨åˆ†ã§ã™ã­ã€‚</p>
<pre><code>If you need to customise these formats, you can by extending a Profile and overriding the appropriate methods.
For an example of this see: https://github.com/d6y/instant-etc/blob/master/src/main/scala/main.scala#L9-L45.
Also of use will be an example of a full mapping, such as: https://github.com/slick/slick/blob/v3.3.0/slick/src/main/scala/slick/jdbc/JdbcTypesComponent.scala#L187-L365.
</code></pre>
<p>ã“ã®å…¬å¼å®Ÿè£…ã¯H2DBã‚’å…ƒã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’å‚è€ƒã«MySQLã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚<br> å…¬å¼ã®æ‹¡å¼µå®Ÿè£…ã¨ã€ä»¥ä¸‹ã®MySQLProfileã®å®Ÿè£…ã‚’æ¯”è¼ƒã—ãªãŒã‚‰å¯¾å¿œã—ã¦ã„ãã¨ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚<br><a href="https://github.com/slick/slick/blob/master/slick/src/main/scala/slick/jdbc/MySQLProfile.scala#L389-L415" target="_blank">MySQLProfile.scala#L389-L415</a></p>
<p>ã§ã¯ã€ä»¥ä¸‹ã«æœ€çµ‚çš„ãªå®Ÿè£…ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚</p>
<p><code>app/slick/profile/MyDBProfile.scala</code></p>
<pre><code>package slick.profile

import java.time.format.DateTimeFormatter
import java.time.LocalDateTime
import java.time.format.DateTimeFormatterBuilder
import java.time.temporal.ChronoField

/* LocalDateTimeã‚’ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã«é©ã—ãŸå½¢ã«å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«Profileè¨­å®šã‚’ç‹¬è‡ªã«æ‹¡å¼µ */
trait MyDBProfile extends slick.jdbc.JdbcProfile with slick.jdbc.MySQLProfile {
  import java.sql.{PreparedStatement, ResultSet}
  import slick.ast.FieldSymbol

  @inline
  private[this] def stringToMySqlString(value : String) : String = {
    value match {
      case null =&gt; &#34;NULL&#34;
      case _ =&gt;
        val sb = new StringBuilder
        sb append &#39;\&#39;&#39;
        for(c &lt;- value) c match {
          case &#39;\&#39;&#39; =&gt; sb append &#34;\\&#39;&#34;
          case &#39;&#34;&#39; =&gt; sb append &#34;\\\&#34;&#34;
          case 0 =&gt; sb append &#34;\\0&#34;
          case 26 =&gt; sb append &#34;\\Z&#34;
          case &#39;\b&#39; =&gt; sb append &#34;\\b&#34;
          case &#39;\n&#39; =&gt; sb append &#34;\\n&#34;
          case &#39;\r&#39; =&gt; sb append &#34;\\r&#34;
          case &#39;\t&#39; =&gt; sb append &#34;\\t&#34;
          case &#39;\\&#39; =&gt; sb append &#34;\\\\&#34;
          case _ =&gt; sb append c
        }
        sb append &#39;\&#39;&#39;
        sb.toString
    }
  }

  override val columnTypes = new JdbcTypes

  // Customise the types...
  class JdbcTypes extends super.JdbcTypes {

   // Postgresã®Profileã‚’å‚è€ƒã«ãƒŸãƒªç§’ã‚‚å«ã‚ã¦å¯¾å¿œã§ãã‚‹formatterã‚’å®Ÿè£…
   private[this] val formatter = {
      new DateTimeFormatterBuilder()
        .append(DateTimeFormatter.ofPattern(&#34;yyyy-MM-dd HH:mm:ss&#34;))
        .optionalStart()
        .appendFraction(ChronoField.NANO_OF_SECOND,0,9,true)
        .optionalEnd()
        .toFormatter()
    }

    override val localDateTimeType : LocalDateTimeJdbcType = new LocalDateTimeJdbcType {
      override def sqlType : Int = {
        java.sql.Types.VARCHAR
      }

      override def setValue(v: LocalDateTime, p: PreparedStatement, idx: Int) : Unit = {
        p.setString(idx, if (v == null) null else v.toString)
      }
      override def getValue(r: ResultSet, idx: Int) : LocalDateTime = {
        r.getString(idx) match {
          case null       =&gt; null
          // æ–‡å­—åˆ—ã‹ã‚‰æ—¥ä»˜å‹ã«ãƒ‘ãƒ¼ã‚¹ã§ãã‚‹ã‚ˆã†ã«parseã«formatterã‚’æ¸¡ã™
          case dateString =&gt; LocalDateTime.parse(dateString, formatter)
        }
      }
      override def updateValue(v: LocalDateTime, r: ResultSet, idx: Int) = {
        r.updateString(idx, if (v == null) null else v.toString)
      }
      override def valueToSQLLiteral(value: LocalDateTime) : String = {
        stringToMySqlString(value.toString)
      }
    }
  }
}

object MyDBProfile extends MyDBProfile
</code></pre>
<p>çµæ§‹ãªã‚³ãƒ¼ãƒ‰é‡ã«è¦‹ãˆã¾ã™ãŒã€ã»ã¨ã‚“ã©ã‚³ãƒ”ãƒšã—ãŸã ã‘ã§ã™ã€‚<br> å¤§äº‹ãªéƒ¨åˆ†ã¯ä»¥ä¸‹ã®ãƒ‘ãƒ¼ã‚¹éƒ¨åˆ†ã§ã™ã­ã€‚</p>
<pre><code>case dateString =&gt; LocalDateTime.parse(dateString, formatter)
</code></pre>
<p>ã»ã¨ã‚“ã©ã¯å…ƒã®MySQLProfileã®å®Ÿè£…ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æŒã£ã¦ãã¦ã„ã‚‹ã ã‘ã§ã™ã€‚<br> ã—ã‹ã—LocalDateTimeã®parseå‡¦ç†ãŒä¿®æ­£ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã®Profileã‚’åˆ©ç”¨ã—ã¦Slickã«è¨­å®šã™ã‚Œã°ç‰¹ã«ä»–ã«ã¯ä½•ã‚‚ã™ã‚‹ã“ã¨ãªãLocalDateTimeãŒãƒ¢ãƒ‡ãƒ«ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ã¡ã‚‡ã£ã¨è©±ã¯é€¸ã‚Œã¾ã™ãŒ<code>.appendFraction</code>ä¾¿åˆ©ã§ã™ã­ã€‚<br> LocalDateTimeã®parseã¯ãƒŸãƒªç§’ã«ã¤ã„ã¦ã¯ä¸€å¾‹ã§è¨­å®šã™ã‚‹æ–¹æ³•ãŒãªãã€ãƒŸãƒªç§’ã®æ•°ã ã‘<code>SSSSSS</code>ã¿ãŸã„ã«æ›¸ã‹ãªã„ã¨ã„ã‘ãªã„ã®ã§LocalDateTimeå´ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§å‡¦ç†ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚<br> ã¾ãŸ0-9ã¾ã§ã®æŒ‡å®šã«ãªã£ã¦ã„ã‚‹ã®ã¯ã€MySQLå´ã§ãƒŸãƒªç§’ä»¥ä¸‹ãŒ1ã¤ã§ã‚‚ã‚ã‚‹ã¨0åŸ‹ã‚ã—ã¦9æ¡ã§å—ã‘å–ã‚ã†ã¨ã™ã‚‹ã‹ã‚‰ã§ã™ã€‚<br> MySQLè‡ªä½“ã¯6æ¡ã¾ã§ã®ç²¾åº¦ã—ã‹ãªã„(ã¯ãš)ã§ã™ã€‚</p>
<p>å°‘ã—é•·ããªã‚Šã¾ã—ãŸãŒæ—¥ä»˜å¯¾å¿œã¯ã“ã‚Œã§å®Œäº†ã§ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="play-slickã‚’åˆ©ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã®æ“ä½œã‚’è¡Œã†" duration="0">
        <p>æœ€å¾Œã«ä»Šã¾ã§ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ã‚„Profileã‚’åˆ©ç”¨ã—ã¦ã€slickã¸å•åˆã›ã‚’è¡Œã†ãŸã‚ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚<br> ã“ã“ã¾ã§ã®å®Ÿè£…ã¯play-slickã¯é–¢ä¿‚ãªãslickã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã®å®Ÿè£…ã§ã—ãŸã€‚<br> ã“ã“ã‹ã‚‰ã¯play-slickã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ä½œæˆã‹ã‚‰ç°¡å˜ãªãƒ‡ãƒ¼ã‚¿å–å¾—ã¾ã§é€²ã‚ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚</p>
<h2 is-upgraded>ãã‚‚ãã‚‚play-slickã¨ã¯ï¼Ÿ</h2>
<p>å®Ÿã¯ç§ã‚ã¾ã‚Šã‚ˆãã‚ã‹ã£ã¦ã„ãªã‹ã£ãŸã®ã§ã™ãŒã€ãã‚‚ãã‚‚play-slickã¨ã¯ãªã‚“ãªã®ã§ã—ã‚‡ã†ã‹ã€‚<br> ã¨è¨€ã†ã“ã¨ã§ã€å…¬å¼æƒ…å ±ã‚’å¼•ç”¨ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚</p>
<pre><code>The Play Slick module makes Slick a first-class citizen of Play, and consists of two primary features:

ãƒ»Integration of Slick into Play&#39;s application lifecycle.
ãƒ»Support for Play database evolutions.
</code></pre>
<p>evolutionsã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã¨ã„ã†ã®ã¯ã€æ¯”è¼ƒçš„ã©ã†ã§ã‚‚ã„ã„ã®ã§ã‚‚ã†ç‰‡æ–¹ã«æ³¨ç›®ã—ã¾ã™ã€‚</p>
<p>ç§ã‚‚ãªã‚“ã¨ãªãæ€ã£ã¦ã¾ã—ãŸãŒã€ã‚„ã£ã±ã‚Šslickã‚’playã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®ä¸­ã«çµ„ã¿è¾¼ã‚“ã§ãã‚Œã‚‹ã®ãŒplay-slickã®ã‚ˆã†ã§ã™ã€‚<br> è¨­å®šæƒ…å ±ã‹ã‚‰DB connectionã‚’ä½œæˆã—ãŸã‚Šç ´æ£„ã—ãŸã‚Šã®ç®¡ç†ã‚’è‰¯ã„æ„Ÿã˜ã«ã‚„ã£ã¦ãã‚Œã‚‹ã‚‚ã®ã€ãã‚‰ã„ã®èªè­˜ã§è‰¯ã„ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚</p>
<p>ãªã®ã§ã€ä»–ã®ãƒ¢ãƒ‡ãƒ«ã§ã‚ã£ãŸã‚Šå…ˆã»ã©ã¾ã§ä½œæˆã—ã¦ã„ãŸprofileãªã©ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨é–¢ä¿‚ãªã„éƒ¨åˆ†ã¯é€šå¸¸ã®slickã¨å¤‰ã‚ã‚‰ãªã„ã¨è¨€ã†ã“ã¨ã§ã™ã­ã€‚</p>
<h2 is-upgraded>play-slickã®ã‚³ãƒ¼ãƒ‰ä¸Šã®æ©Ÿèƒ½</h2>
<p>ã§ã¯ã€ãã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãŒäº‘ã€…ã¨ã„ã†ã®ãŒã‚³ãƒ¼ãƒ‰ä¸Šã©ã†ãªã‚‹ã‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚<br> å…¬å¼ã‚µã‚¤ãƒˆã®ãƒšãƒ¼ã‚¸ã§ã¯<a href="https://www.playframework.com/documentation/2.8.x/PlaySlick#DatabaseConfig-via-runtime-dependency-injection" target="_blank">ã“ã¡ã‚‰ã‚’å‚ç…§</a></p>
<p>å…¬å¼ã‚µã‚¤ãƒˆã®ä¾‹ã§ã¯controllerã«å¯¾ã—ã¦DIã™ã‚‹ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã­ã€‚<br> ä»¥ä¸‹ã¯ã‚ãã¾ã§ã€Œã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã€ã§å®Ÿéš›ã«åˆ©ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã“ã®å®Ÿè£…ã‚’ä»Šã®<code>TweetController</code>ã«é©ç”¨ã™ã‚‹ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã‚Šã¾ã™ã€‚(å®Ÿè£…ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“)</p>
<p><code>app/controllers/tweet/TweetController.scala</code></p>
<pre><code>@Singleton
class TweetController @Inject()(
  protected val dbConfigProvider: DatabaseConfigProvider, // play-slick
  val controllerComponents: ControllerComponents
)(implicit ec: ExecutionContext)
extends BaseController
with I18nSupport
with HasDatabaseConfigProvider[JdbcProfile]{ // play-slick

  // HasDatabaseConfigProviderã®æŒã¤profileã‹ã‚‰apiã‚’å–å¾—
  // slickã§ã„ã†ã¨ã“ã‚ã®slick.jdbc.MySQLProfile.api._
  import profile.api._

// ...çœç•¥...
}

</code></pre>
<p><code>// play-slick</code> ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ãŸéƒ¨åˆ†ãŒplay-slickç”¨ã®å®Ÿè£…ã§ã™ã€‚<br> å®Ÿè£…ã®å®Ÿæ…‹ã¯<code>HasDatabaseConfigProvider</code>ãŒæŒã£ã¦ã„ã¦ã€ãã®ä¸­ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹å¤‰æ•°ã¨ã—ã¦<code>DatabaseConfigProvider</code>ãŒã„ã¾ã™ã€‚<br> ã“ã®<code>DatabaseConfigProvider</code>ã‚’play-slickãŒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰çµ„ã¿ç«‹ã¦ã¦Injectã€ãã®çµæœé©åˆ‡ãªprofileã‚’èª­ã¿å–ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã„ã†ä»•çµ„ã¿ã§ã™ã€‚</p>
<p>Controllerã‚¯ãƒ©ã‚¹å†…éƒ¨ã®<code>import dbConfig.profile.api._</code>ã®éƒ¨åˆ†ãŒProfileã‹ã‚‰slickã®å‡¦ç†ã«å¿…è¦ãªæ©Ÿèƒ½ã‚’importã—ã¦ã„ã‚‹éƒ¨åˆ†ã«ãªã‚Šã¾ã™ã€‚<br> ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚‚è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ãŒã€ãã®ã¾ã¾ã®slickã ã¨<code>import slick.profile.MySQLProfile.api._</code>ã®ã‚ˆã†ã«åˆ©ç”¨ã—ã¦ã‚‹ã‚‚ã®ã«ã‚ãŸã‚Šã¾ã™ã€‚</p>
<p>play-slickã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§RDBã®é•ã„ã‚’ç°¡å˜ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«éš è”½ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã­ã€‚</p>
<p>ã§ã¯ã€ã“ã®play-slickã‚’åˆ©ç”¨ã—ã¦å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚<br> ä»Šå›ã¯play-slickã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚è€ƒã«<code>Repository</code>ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã™ã‚‹å½¢ã§å®Ÿè£…ã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚<br> ã“ã“ã§ç´¹ä»‹ã—ãŸ<code>DatabaseConfigProvider</code>é–¢é€£ã®DIã‚‚Controllerã§ã¯ãªãRepositoryã«å¯¾ã—ã¦è¡Œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
<h2 is-upgraded>Tweeté–¢é€£ã®DBã‚¢ã‚¯ã‚»ã‚¹ç”¨ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹</h2>
<p>ã§ã¯ã€ã•ã£ããTweet Tableã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚<br> slick-codegeã§ä½œæˆã—ãŸã‚¯ãƒ©ã‚¹ã‚„ã€play-slickã®ã‚µãƒ³ãƒ—ãƒ«ã‚’å‚è€ƒã«ã—ãªãŒã‚‰ä½œæˆã—ã¦ã„ãã¾ã™ã€‚</p>
<p>ã¾ãšã¯ãƒ¢ãƒ‡ãƒ«ä½œæˆã—ã¦ã„ãã®ã§ã™ãŒã€å…ƒã€…ä½œæˆã•ã‚Œã¦ã„ãŸTweetãƒ¢ãƒ‡ãƒ«ã‚’ç§»å‹•ã•ã›ã¦ç¾åœ¨ã®tableã«åˆã‚ã›ã¦èª¿æ•´ã‚’ã—ã¾ã™ã€‚</p>
<p><code>app/models/Tweet.scala</code> -&gt; <code>app/slick/models/Tweet.scala</code></p>
<pre><code>package slick.models

import java.time.LocalDateTime

// case classã«ã¤ã„ã¦ã®èª¬æ˜ã¯çœç•¥
// å‚è€ƒ: https://docs.scala-lang.org/ja/tour/case-classes.html
case class Tweet(
  id:        Option[Long],
  content:   String,
  postedAt:  LocalDateTime = LocalDateTime.now,
  createdAt: LocalDateTime = LocalDateTime.now,
  updatedAt: LocalDateTime = LocalDateTime.now
)
</code></pre>
<p>â€» ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨models.Tweetã‚’åˆ©ç”¨ã—ã¦ã„ãŸç®‡æ‰€ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€é©å®œä¿®æ­£ã—ã¦ãã ã•ã„ã€‚slick.ã‚’ã¤ã‘ã¦ã‚ã’ã‚‹ã ã‘ã§å¤§ä¸ˆå¤«ãªã¯ãšã§ã™ã€‚</p>
<p>æ¬¡ã«Repositoryã‚’ä½œæˆã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚<br> ã“ã®å®Ÿéš›ã¯ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚<br><a href="https://github.com/playframework/play-slick/blob/master/samples/basic/app/dao/CatDAO.scala" target="_blank">Playå…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦å¼•ç”¨ã•ã‚Œã¦ã„ã‚‹å®Ÿè£…</a></p>
<p><code>app/slick/repositories/TweetRepository.scala</code></p>
<pre><code>package slick.repositories

import java.time.LocalDateTime
import play.api.db.slick.{HasDatabaseConfigProvider,DatabaseConfigProvider}
import javax.inject.{Inject, Singleton}
import slick.jdbc.{JdbcProfile, GetResult}
import scala.concurrent.{Future, ExecutionContext}
import slick.models.Tweet

@Singleton
class TweetRepository @Inject()(
  protected val dbConfigProvider: DatabaseConfigProvider
)(implicit ec: ExecutionContext)
extends HasDatabaseConfigProvider[JdbcProfile] {
  import profile.api._

  private val tweet = new TableQuery(tag =&gt; new TweetTable(tag))

  // ########## [DBIO Methods] ##########

  /**
    * tweetã‚’å…¨ä»¶å–å¾—
    */
  def all(): Future[Seq[Tweet]] = db.run(tweet.result)

  // ########## [Table Mapping] ##########
  private class TweetTable(_tableTag: Tag) extends Table[Tweet](_tableTag, Some(&#34;twitter_clone&#34;), &#34;tweet&#34;) {

    // Tableã¨ã®ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°
    val id:        Rep[Long]          = column[Long](&#34;id&#34;, O.AutoInc, O.PrimaryKey)
    val content:   Rep[String]        = column[String](&#34;content&#34;, O.Length(120,varying=true))
    val postedAt:  Rep[LocalDateTime] = column[LocalDateTime](&#34;posted_at&#34;)
    val createdAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;created_at&#34;)
    val updatedAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;updated_at&#34;)

    // Plain SQLã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è¡Œã†ç”¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    implicit def GetResultTweet(implicit e0: GetResult[Long], e1: GetResult[String], e2: GetResult[LocalDateTime]): GetResult[Tweet] = GetResult{
      prs =&gt; import prs._
      Tweet.tupled((Some(&lt;&lt;[Long]), &lt;&lt;[String], &lt;&lt;[LocalDateTime], &lt;&lt;[LocalDateTime], &lt;&lt;[LocalDateTime]))
    }

    // model -&gt; dbç”¨ã‚¿ãƒ—ãƒ«, dbã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ -&gt; modelã®å¤‰æ›ã‚’è¨˜è¿°ã™ã‚‹å‡¦ç†
    // O.PrimaryKeyã¯ColumnOptionTypeã¨ãªã‚‹ãŸã‚id.?ã§idã‚’Optionã¨ã—ã¦å–ã‚Šæ‰±ã„å¯èƒ½
    def * = (id.?, content, postedAt, createdAt, updatedAt) &lt;&gt; (Tweet.tupled, Tweet.unapply)

    def ? = ((Rep.Some(id), Rep.Some(content), Rep.Some(postedAt), Rep.Some(createdAt), Rep.Some(updatedAt))).shaped.&lt;&gt;({r=&gt;import r._; _1.map(_=&gt; Tweet.tupled((Option(_1.get), _2.get, _3.get, _4.get, _5.get)))}, (_:Any) =&gt;  throw new Exception(&#34;Inserting into ? projection not supported.&#34;))

  }
}
</code></pre>
<p>å°‘ã—é•·ããªã£ã¦ã„ã¾ã™ãŒã€ä¸€ã¤ãšã¤èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚<br> ã¾ãšã‚¯ãƒ©ã‚¹å®£è¨€ã®éƒ¨åˆ†ã§ã™ã€‚</p>
<pre><code>@Singleton
class TweetRepository @Inject()(
  protected val dbConfigProvider: DatabaseConfigProvider
)(implicit ec: ExecutionContext)
extends HasDatabaseConfigProvider[JdbcProfile] {
  import profile.api._
</code></pre>
<p>ã“ã®éƒ¨åˆ†ã¯å‰æ®µã§èª¬æ˜ã—ãŸControllerã®å®Ÿè£…ã¨ã»ã¼åŒã˜ã§ã™ã€‚<br> Repositoryã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¤‡æ•°æŒã¤å¿…è¦ãŒãªã„(ã¨ãŠã‚‚ã†)ã®ã§<code>@Singleton</code> ã‚’ä»˜ä¸ã—ã¦ã€Singletonã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã—ã¦ã„ã¾ã™ã€‚</p>
<p>ã¾ãŸä»Šå›<code>(implicit ec: ExecutionContext)</code>ã®è¨˜è¿°ã‚‚è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚<br> slickã¯å•åˆã›çµæœã‚’<code>Future</code>å‹ã§è¿”ã—ã¦ãã‚‹ãŸã‚ã€Futureã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ãªExecutionContextãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚<br> ãã“ã§Playæ¨™æº–ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ExecutionContextã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã€ã‚¯ãƒ©ã‚¹å®£è¨€æ™‚ã«DIã§å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚<br> ã“ã®è¾ºã¯Scalaã®è©±ã«ãªã£ã¦ã—ã¾ã†ã®ã§æœ¬ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚</p>
<p>æ¬¡ã«å®Ÿè£…ã®ä¸‹ã®éƒ¨åˆ†ã«ã‚ã‚‹Table Mappingã®ãƒ–ãƒ­ãƒƒã‚¯ã§ã™ã€‚</p>
<pre><code>// ########## [Table Mapping] ##########
private class TweetTable(_tableTag: Tag) extends Table[Tweet](_tableTag, Some(&#34;twitter_clone&#34;), &#34;tweet&#34;) {

  // Tableã¨ã®ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°
  val id:        Rep[Long]          = column[Long](&#34;id&#34;, O.AutoInc, O.PrimaryKey)
  val content:   Rep[String]        = column[String](&#34;content&#34;, O.Length(120,varying=true))
  val postedAt:  Rep[LocalDateTime] = column[LocalDateTime](&#34;posted_at&#34;)
  val createdAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;created_at&#34;)
  val updatedAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;updated_at&#34;)

  // Plain SQLã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è¡Œã†ç”¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°
  implicit def GetResultTweet(implicit e0: GetResult[Long], e1: GetResult[String], e2: GetResult[LocalDateTime]): GetResult[Tweet] = GetResult{
    prs =&gt; import prs._
    Tweet.tupled((Some(&lt;&lt;[Long]), &lt;&lt;[String], &lt;&lt;[LocalDateTime], &lt;&lt;[LocalDateTime], &lt;&lt;[LocalDateTime]))
  }

  // model -&gt; dbç”¨ã‚¿ãƒ—ãƒ«, dbã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ -&gt; modelã®å¤‰æ›ã‚’è¨˜è¿°ã™ã‚‹å‡¦ç†
  // O.PrimaryKeyã¯ColumnOptionTypeã¨ãªã‚‹ãŸã‚id.?ã§idã‚’Optionã¨ã—ã¦å–ã‚Šæ‰±ã„å¯èƒ½
  def * = (id.?, content, postedAt, createdAt, updatedAt) &lt;&gt; (Tweet.tupled, Tweet.unapply)

  // Maps whole row to an option. Useful for outer joins.
  def ? = ((
    Rep.Some(id),
    Rep.Some(content),
    Rep.Some(postedAt),
    Rep.Some(createdAt),
    Rep.Some(updatedAt)
  )).shaped.&lt;&gt;(
  { r =&gt;
    import r._;
    _1.map( _=&gt;
        Tweet.tupled((
          Option(_1.get), // ãƒ¢ãƒ‡ãƒ«å´ã¯idãŒOptionãªã®ã§Optionã§åŒ…ã‚“ã§ã„ã‚‹
          _2.get,
          _3.get,
          _4.get,
          _5.get
        ))
  )},
  (_:Any) =&gt;
    throw new Exception(&#34;Inserting into ? projection not supported.&#34;)
  )
}
</code></pre>
<p>ã“ã‚Œã¯slick-codegenã§ä½œæˆã•ã‚ŒãŸã‚‚ã®ã‚’å‚è€ƒã«ä¿®æ­£ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚</p>
<p>ä»¥ä¸‹ã®éƒ¨åˆ†ãŒTableã¨Scalaå´ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿å‹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã§ã™ã€‚<br><code>column[LocalDateTime]</code>ã®éƒ¨åˆ†ãŒã€ç‹¬è‡ªã§ä½œæˆã—ã¦MyDBProfileã®ãŠã‹ã’ã§ãƒãƒƒãƒ”ãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹å ´æ‰€ã§ã™ã€‚<br> ã“ã®éƒ¨åˆ†ãŒé€šå¸¸ã®ORMã®ãƒ¢ãƒ‡ãƒ«å®šç¾©é¢¨ã§ã™ã‚ˆã­ã€‚</p>
<pre><code>// Tableã¨ã®ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°
val id:        Rep[Long]          = column[Long](&#34;id&#34;, O.AutoInc, O.PrimaryKey)
val content:   Rep[String]        = column[String](&#34;content&#34;, O.Length(120,varying=true))
val postedAt:  Rep[LocalDateTime] = column[LocalDateTime](&#34;posted_at&#34;)
val createdAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;created_at&#34;)
val updatedAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;updated_at&#34;)
</code></pre>
<p>æ¬¡ã«ä»¥ä¸‹ã®éƒ¨åˆ†ã€‚</p>
<pre><code>// Plain SQLã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è¡Œã†ç”¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°
implicit def GetResultTweet(implicit e0: GetResult[Long], e1: GetResult[String], e2: GetResult[LocalDateTime]): GetResult[Tweet] = GetResult{
  prs =&gt; import prs._
  Tweet.tupled((Some(&lt;&lt;[Long]), &lt;&lt;[String], &lt;&lt;[LocalDateTime], &lt;&lt;[LocalDateTime], &lt;&lt;[LocalDateTime]))
}
</code></pre>
<p>ã“ã‚Œã¯slickã‹ã‚‰Plain SQLã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«åˆ©ç”¨ã•ã‚Œã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°ã§ã™ã€‚<br> Plain SQLã¨ã„ã†ã®ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹æ³•ã§ã®DBIOå®Ÿè¡Œã§ã™ã€‚</p>
<pre><code>sql&#34;SELECT * FROM tweet&#34;.as[Tweet]
</code></pre>
<p>ã“ã®aså¥ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«å¿…è¦ãªimplicitã¨ã„ã†ã‚ã‘ã§ã™ã­ã€‚<br> ã“ã‚ŒãŒãªã„å ´åˆã«ã¯ <code>as[(Long, String, LocalDateTime, LocalDateTime, LocalDateTime)]</code>ã®ã‚ˆã†ã«ã‚¿ãƒ—ãƒ«ã§æŒ‡å®šã—ã¦åˆ©ç”¨ã™ã‚‹å½¢ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ãªã®ã§ã€ã“ã®å®Ÿè£…ã¯å¿…ãšã—ã‚‚å¿…é ˆã®å®Ÿè£…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>æ¬¡ã«<code>def *</code><br> ã“ã‚ŒãŒä¸€ç•ªé‡è¦ã§ã€slickã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã«é€šå¸¸åˆ©ç”¨ã•ã‚Œã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°ã®å®šç¾©ã§ã™ã€‚</p>
<pre><code>// model -&gt; dbç”¨ã‚¿ãƒ—ãƒ«, dbã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ -&gt; modelã®å¤‰æ›ã‚’è¨˜è¿°ã™ã‚‹å‡¦ç†
// O.PrimaryKeyã¯ColumnOptionTypeã¨ãªã‚‹ãŸã‚id.?ã§idã‚’Optionã¨ã—ã¦å–ã‚Šæ‰±ã„å¯èƒ½
def * = (id.?, content, postedAt, createdAt, updatedAt) &lt;&gt; (Tweet.tupled, Tweet.unapply)
</code></pre>
<p>ã“ã“ã«å®šç¾©ã—ãŸå†…å®¹ã§select, insert, updateãªã©ã®å‡¦ç†ã‚’DBå´ã«ä¸Šæ‰‹ããƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®æµã—è¾¼ã¿ã‚„å—ã‘å–ã‚ŠãŒè¡Œã‚ã‚Œã¾ã™ã€‚<br><code>id.?</code>ã®éƒ¨åˆ†ã§ã™ãŒã€ã“ã‚Œã¯PrimaryKeyã«å¯¾ã—ã¦è¡Œãˆã‚‹å‘¼ã³å‡ºã—æ–¹ã«ãªã‚Šã¾ã™ã€‚<br> ä¸»ã‚­ãƒ¼ã¯AutoIncã§è‡ªå‹•æ¡ç•ªã«ã—ã¦insertæ™‚ã«ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰æŒ‡å®šã›ãšã€DBå´ã§é€£ç•ªã‚’ä»˜ä¸ã•ã›ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã‚ˆã­ã€‚<br> ãã®ãŸã‚Slickã§ã‚‚ç™»éŒ²æ™‚ã«ã¯Optionã§ã‚ã‚‹ã“ã¨ã‚’è¨±å®¹ã—ã¦ã€selectæ™‚ã«ã¯éOptionã®å‹ã§å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«<code>.?</code>ã¨ã„ã†å®šç¾©ã®ä»•æ–¹ã‚’ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã‹ãªã‚Šå®šç¾©ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã‹ã‘ã‚‹ã®ã§ã€è¦šãˆã¦ãŠã„ã¦ãã ã•ã„ã€‚</p>
<p>ã¡ãªã¿ã«tupledã§ã™ã‚“ãªã‚Šå‡¦ç†ã§ããªã„å ´åˆã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<pre><code>// model -&gt; dbç”¨ã‚¿ãƒ—ãƒ«, dbã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ -&gt; modelã®å¤‰æ›ã‚’è¨˜è¿°ã™ã‚‹å‡¦ç†
def * = (id, content, postedAt, createdAt, updatedAt) &lt;&gt; (
  (x: (Long, String, LocalDateTime, LocalDateTime, LocalDateTime)) =&gt; {
    Tweet(Some(x._1), x._2 ,x._3, x._4, x._5)
  },
  (tweet: Tweet) =&gt; {
    Some((tweet.id.getOrElse(0L), tweet.content, tweet.postedAt, tweet.createdAt, tweet.updatedAt))
  }
)
</code></pre>
<p>ã“ã‚Œã¯<code>id.?</code>ã‚’ä½¿ã‚ãªã‹ã£ãŸå ´åˆã®æ›¸ãæ–¹ã®ä¸€ä¾‹ã¿ãŸã„ãªå½¢ã§ã™ãŒã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯tupled, unapplyã‚’è‡ªåˆ†ã§æ›¸ã„ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚</p>
<p>ãã—ã¦æœ€å¾Œã«<code>def ?</code>ã§ã™ã€‚</p>
<pre><code>// Maps whole row to an option. Useful for outer joins.
def ? = ((
  Rep.Some(id),
  Rep.Some(content),
  Rep.Some(postedAt),
  Rep.Some(createdAt),
  Rep.Some(updatedAt)
)).shaped.&lt;&gt;(
{ r =&gt;
  import r._;
  _1.map( _=&gt;
      Tweet.tupled((
        Some(_1.get), // ãƒ¢ãƒ‡ãƒ«å´ã¯idãŒOptionãªã®ã§Optionã§åŒ…ã‚“ã§ã„ã‚‹
        _2.get,
        _3.get,
        _4.get,
        _5.get
      ))
)},
(_:Any) =&gt;
  throw new Exception(&#34;Inserting into ? projection not supported.&#34;)
)
</code></pre>
<p>ã“ã“ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ã‚ˆã†ã«ã€idã®éƒ¨åˆ†ã‚’Optionã§åŒ…ã‚€ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚<br> ã“ã®å®Ÿè£…ã¯å®Ÿã¯ç§ã‚‚ã‚ˆãã‚ã‹ã£ã¦ã„ãªã„ã®ã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã¨ãã«ã‚‚ãªã‚“ã‹ã„ã„æ„Ÿã˜ã«ã—ã¦ãã‚Œã‚‹ã£ã½ã„ã“ã¨ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã­ã€‚</p>
<p>ã“ã‚Œã§DBã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ãŒä½œæˆã§ãã¾ã—ãŸã€‚</p>
<h2 is-upgraded>ç‹¬è‡ªå®Ÿè£…ã—ãŸprofileã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹</h2>
<p>å¿…è¦ãªå®Ÿè£…ã¯çµ‚ã‚ã‚Šã¾ã—ãŸãŒplay-slické–¢é€£ã®å®Ÿè£…ã®ä¸­ã§profileã‚’æŒ‡å®šã™ã‚‹å ´æ‰€ãŒè¦‹å½“ãŸã‚Šã¾ã›ã‚“ã§ã—ãŸã­ã€‚<br> ã“ã“ã§ã¯ç‹¬è‡ªå®Ÿè£…ã—ãŸprofileã‚’åˆ©ç”¨ã—ã¦slickãŒå‹•ã„ã¦ãã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã‚’ã—ã¦ã„ãã¾ã™ã€‚</p>
<p>ã¨ã„ã£ã¦ã‚‚ã€è¡Œã†ã“ã¨ã¯å˜ç´”ã§<code>application.conf</code>ã‚’ä¿®æ­£ã™ã‚‹ã ã‘ã§ã™ã€‚</p>
<p><code>conf/application.conf</code></p>
<pre><code>slick {
  dbs {
    default {
      # ç‹¬è‡ªå®Ÿè£…ã—ãŸprofileã‚’æŒ‡å®š
      profile = &#34;slick.profile.MyDBProfile$&#34;
      db {
        driver   = com.mysql.cj.jdbc.Driver,
        url      = &#34;jdbc:mysql://db:3306/twitter_clone?useSSL=false&#34;,
        user     = &#34;root&#34;,
        password = &#34;root&#34;,
      }
    }
  }
  codegen {
    # ã“ã“ã§ã®.ã¯root directoryã¨ãªã‚‹
    outputDir = &#34;./output/codegen&#34;
  }
}
</code></pre>
<p>slické–¢é€£ã®è¨­å®šã ã‘æŠœç²‹ã—ã¦ã„ã¾ã™ã€‚<br><code>slick.dbs.default.profile</code>ã®éƒ¨åˆ†ã‚’ä¿®æ­£ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚<br> ã“ã‚Œã«ã‚ˆã£ã¦play-slickãŒã“ã®è¨­å®šã‚’èª­ã¿ã«è¡Œã£ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<p>confã®è¨­å®šã¯ã“ã‚Œã§å®Œäº†ã§ã™ã€‚</p>
<p>ã“ã‚Œã§slickã«é–¢ã™ã‚‹å®Ÿè£…ã¯å®Œäº†ã§ã™ï¼</p>
<p>æ¬¡ã®ç« ã‹ã‚‰ã¯ã€ã“ã‚Œã‚‰ã‚’åˆ©ç”¨ã—ã¦CRUDã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="ãŠã¾ã‘" duration="0">
        <p>ã“ã“ã‹ã‚‰ã¯slickã®ãƒãƒƒãƒ”ãƒ³ã‚°ã®åˆ¥ã®æ›¸ãæ–¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚<br> ä»Šå›ã¯ã‚ãã¾ã§LocalDateTimeã«å¯¾ã—ã¦ã®è¨˜è¼‰ã«ãªã‚Šã¾ã™ãŒã€ç‹¬è‡ªå‹ã‚„ãã®ä»–ã«ã¤ã„ã¦ã‚‚ã“ã‚Œã‚‰ã‚’åˆ©ç”¨ã—ã¦å¯¾å¿œã§ãã¾ã™ã€‚</p>
<h2 is-upgraded>MappedColumnTypeã‚’åˆ©ç”¨ã—ãŸãƒãƒƒãƒ”ãƒ³ã‚°</h2>
<p>é€šå¸¸ã§ã‚ã‚Œã°slickã¯ã“ã®æ–¹æ³•ã§å¤–éƒ¨ã®å‹ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚<br> ãŸã ã—ã€ä»Šå›ã®LocalDateTimeã«ã¤ã„ã¦ã¯ä¾‹å¤–ã§ã“ã®æ–¹æ³•ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>
<p>ã“ã®å®Ÿè£…ã«ã¤ã„ã¦ã¯<a href="https://qiita.com/lightstaff/items/cb247f98b9bb12213de9" target="_blank">ã“ã¡ã‚‰</a>ã®è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ã¦ã„ã¾ã™ã€‚</p>
<p>å®Ÿè£…ã‚’è¦‹ãŸæ–¹ãŒæ—©ã„ã®ã§ã€ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¾ã™ã€‚</p>
<p><code>app/slick/samples/SlickMappedMySQLDateTime.scala</code></p>
<pre><code>package slick.samples

import java.time.format.DateTimeFormatter
import java.time.LocalDateTime

/* MySQLDateTimeã‚’ç›´æ¥ãƒãƒƒãƒ”ãƒ³ã‚°å¯¾è±¡ã«ã§ããªã„ã®ã§ã€mappingã«åˆ©ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹ */
case class MySQLDateTime(v: String) {
  def toLocalDateTime: LocalDateTime = LocalDateTime.parse(v, MySQLDateTime.format)
}

object MySQLDateTime {
  val format = DateTimeFormatter.ofPattern(&#34;yyyy-MM-dd HH:mm:ss&#34;)
  def apply(time: LocalDateTime): MySQLDateTime = MySQLDateTime(time.format(format))
}


trait LocalDateTimeColumMapper {
  val profile: slick.jdbc.JdbcProfile
  import profile.api._

  implicit lazy val localDateTimeMapper = MappedColumnType.base[MySQLDateTime, String] (
    { ldt =&gt; ldt.v },
    { str =&gt; MySQLDateTime(str)}
  )
}
</code></pre>
<p>ã¾ãš<code>MySQLDateTime</code>ã¨ã„ã†<code>case class</code>ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚<br> ã“ã“ãŒä½¿ã„ã¥ã‚‰ã„åŸå› ã«ãªã£ã¦ã„ã‚‹ç®‡æ‰€ã§ã™ã€‚</p>
<p>æœ¬å½“ã¯ç›´æ¥LocalDateTimeã«ç´ã¥ã‘ãŸã„ã®ã§ã™ãŒã€MySQLProfileã«ã§LocalDateTimeã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ä½œæˆã—ãŸMappedColumnTypeã‚ˆã‚Šå…ˆã«MySQLProfileã®getValueå‡¦ç†ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã—ã¾ã†ã‚ˆã†ã§ã—ãŸã€‚</p>
<p>ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªMappingã‚’ã€ä½œæˆã—ã¦ã€‚</p>
<pre><code>MappedColumnType.base[LocalDateTime, String] (
    { ldt =&gt; ldt.toString },
    { str =&gt; LocalDateTime.parse(str, formatter)}
  )
</code></pre>
<p>ã•ã‚‰ã«ãƒ¢ãƒ‡ãƒ«å´ã§ä»¥ä¸‹ã®ã‚ˆã†ã«å®£è¨€ã‚’ã—ã¦ã¿ã¾ã™ã€‚</p>
<p><code>val createdAt: Rep[LocalDateTime] = column[LocalDateTime](&#34;created_at&#34;)</code></p>
<p>ã“ã®å ´åˆProfileã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹LocalDateTimeã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒå…ˆã«å‡¦ç†ã•ã‚Œã¦ã€ãã®å¾Œã«MappedColumnTypeã®å‡¦ç†ã«ç§»ã‚ã†ã—ã¾ã™ã€‚<br> ãªã®ã§çµå±€ã¯getValueã®LocalDateTime.parseã®ç®‡æ‰€ã§è½ã¡ã¦ã—ã¾ã†ã‚“ã§ã™ã€‚</p>
<p>ã‹ã¨ã„ã£ã¦Stringã«å¯¾ã—ã¦ã®mappingã«ã—ã¦ã—ã¾ã†ã¨ã€æ™®é€šã«Stringã§ä½¿ã„ãŸã„ã‚‚ã®ã«ã¤ã„ã¦ã‚‚å¤‰æ›ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã¾ã™ã€‚<br> ãã®ãŸã‚LocalDateTimeã‚’ç›´æ¥ä½¿ã†ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚</p>
<p>ãã®ãŸã‚ä¸€åº¦çµŒç”±ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã¨ã—ã¦ç‹¬è‡ªã®<code>MySQLDateTime</code>ã¨ã„ã†å‹ãŒå¿…è¦ã«ãªã£ã¦ã—ã¾ã£ãŸã¨è¨€ã†ã‚ã‘ã§ã™ã€‚<br> æ—¢ã«è‹¥å¹²å†—é•·ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚</p>
<p>ã—ã‹ã—ã€ã“ã®å®Ÿè£…ã ã¨ã¾ãŸã‚‚ã†ã¡ã‚‡ã£ã¨å¤§å¤‰ãªã¨ã“ã‚ãŒã‚ã‚Šã¾ã™ã€‚<br> ãƒ¢ãƒ‡ãƒ«å´ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<p><code>app/slick/samples/SlickMappedTweetV1.scala</code></p>
<pre><code>package slick.samples

import java.time.LocalDateTime
import slick.jdbc.{GetResult}
import slick.models.Tweet

// ...ä¸€éƒ¨ã‚’æŠœç²‹...

  /* Slick3.3ã§ã¯DATETIME, TIMESTAMPãªã©ã‚’Stringã§å—ã‘å–ã‚‹ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã¨ã®ç›¸äº’å¤‰æ›éƒ¨åˆ†ã§å¸åã™ã‚‹ */
  implicit def GetResultTweet(implicit e0: GetResult[Long], e1: GetResult[String], e2: GetResult[MySQLDateTime]): GetResult[Tweet] = GetResult{
    prs =&gt; import prs._
    Tweet.tupled((
      &lt;&lt;[Option[Long]],
      &lt;&lt;[String],
      &lt;&lt;[MySQLDateTime].toLocalDateTime,
      &lt;&lt;[MySQLDateTime].toLocalDateTime,
      &lt;&lt;[MySQLDateTime].toLocalDateTime
    ))
  }

  /* Slick3.3ã§ã¯DATETIME, TIMESTAMPãªã©ã‚’Stringã§å—ã‘å–ã‚‹ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã¨ã®ç›¸äº’å¤‰æ›éƒ¨åˆ†ã§å¸åã™ã‚‹ */
 class SlickMappedTweetTableV1(_tableTag: Tag) extends profile.api.Table[Tweet](_tableTag, Some(&#34;twitter_clone&#34;), &#34;tweet&#34;) {

    def * = (id, content, postedAt, createdAt, updatedAt) &lt;&gt; (
      (x: (Long, String, MySQLDateTime, MySQLDateTime, MySQLDateTime)) =&gt; {
        Tweet(
          Some(x._1),
          x._2,
          x._3.toLocalDateTime,
          x._4.toLocalDateTime,
          x._5.toLocalDateTime
        )
      },
      (tweet: Tweet) =&gt; {
        Some((
          tweet.id.getOrElse(0L),
          tweet.content,
          MySQLDateTime(tweet.postedAt.toString),
          MySQLDateTime(tweet.createdAt.toString),
          MySQLDateTime(tweet.updatedAt.toString)
        ))
      }
    )

    def ? = ((Rep.Some(id), Rep.Some(content), Rep.Some(postedAt), Rep.Some(createdAt), Rep.Some(updatedAt))).shaped.&lt;&gt;({r=&gt;import r._; _1.map(_=&gt; Tweet.tupled((Option(_1.get), _2.get, MySQLDateTime(_3.get.toString).toLocalDateTime, MySQLDateTime(_4.get.toString).toLocalDateTime, MySQLDateTime(_5.get.toString).toLocalDateTime)))}, (_:Any) =&gt;  throw new Exception(&#34;Inserting into ? projection not supported.&#34;))

</code></pre>
<p>å®Ÿè£…ã‚’è¦‹ã‚‹ã¨ã‚ã‹ã‚Šã¾ã™ãŒã€ã›ã£ã‹ãMappedColumnTypeã‚’ã—ã¦ã„ã‚‹ã®ã«ãƒ¢ãƒ‡ãƒ«å´ã§ã‚‚å–ã‚Šå›ã—ã®å‡¦ç†ã‚’ã‚±ã‚¢ã—ã¦ã‚ã’ãªã„ã¨ã„ã‘ãªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<p>ã“ã®ã‚ˆã†ã«MappedColumnTypeã§ã®å®Ÿè£…ã ã¨ã€å¿…è¦ã«ãªã‚‹ã‚³ãƒ¼ãƒ‰é‡ã¯å¢—ãˆã‚‹ã®ã«çµå±€ã‚±ã‚¢ã‚‚ã—ãªã„ã¨ã„ã‘ãªã„ã¨ã„ã†ã“ã¨ã§æ‰‹é–“ãŒå€ã«å¢—ãˆã¦ã—ã¾ã„ã¾ã—ãŸã€‚<br> ãã®ãŸã‚ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã«ã¤ã„ã¦ã¯é©åˆ‡ã§ã¯ãªã•ãã†ã§ã™ã€‚</p>
<h2 is-upgraded>Stringã®ã¾ã¾å—ã‘å–ã£ã¦å€‹åˆ¥ã«ãƒãƒƒãƒ”ãƒ³ã‚°</h2>
<p>ã“ã¡ã‚‰ã¯å®Ÿè£…ã®ä¸­èº«ã‚’ç†è§£ã—ã‚„ã™ãã€æ‰‹é–“ã¯å°‘ã—ã‹ã‹ã‚Šã¾ã™ãŒã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã ã¨æ€ã„ã¾ã™ã€‚</p>
<p><code>app/slick/samples/TupleMappedTweet.scala</code></p>
<pre><code>package slick.samples

import java.time.LocalDateTime
import slick.jdbc.{GetResult}
import java.time.format.DateTimeFormatter
import slick.models.Tweet

/* def *ã®tupleã§ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£… */
object TupleMappedTweetTable extends {
  val profile    = slick.jdbc.MySQLProfile
} with TupleMappedTweetTable

trait TupleMappedTweetTable {
  val profile: slick.jdbc.JdbcProfile
  val format = DateTimeFormatter.ofPattern(&#34;yyyy-MM-dd HH:mm:ss&#34;)

  import profile.api._

  /* Slick3.3ã§ã¯DATETIME, TIMESTAMPãªã©ã‚’Stringã§å—ã‘å–ã‚‹ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã¨ã®ç›¸äº’å¤‰æ›éƒ¨åˆ†ã§å¸åã™ã‚‹ */
  implicit def GetResultTweet(implicit e0: GetResult[Long], e1: GetResult[String]): GetResult[Tweet] = GetResult{
    prs =&gt; import prs._
    Tweet.tupled((
      &lt;&lt;[Option[Long]],
      &lt;&lt;[String],
      LocalDateTime.parse(&lt;&lt;[String], format),
      LocalDateTime.parse(&lt;&lt;[String], format),
      LocalDateTime.parse(&lt;&lt;[String], format)
    ))
  }

  /* Slick3.3ã§ã¯DATETIME, TIMESTAMPãªã©ã‚’Stringã§å—ã‘å–ã‚‹ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã¨ã®ç›¸äº’å¤‰æ›éƒ¨åˆ†ã§å¸åã™ã‚‹ */
  class TupleMappedTweetTable(_tableTag: Tag) extends profile.api.Table[Tweet](_tableTag, Some(&#34;twitter_clone&#34;), &#34;tweet&#34;) {
    def * = (id, content, postedAt, createdAt, updatedAt) &lt;&gt; (
      (x: (Long, String, String, String, String)) =&gt; {
        Tweet(
          Some(x._1),
          x._2,
          LocalDateTime.parse(x._3, format),
          LocalDateTime.parse(x._4, format),
          LocalDateTime.parse(x._5, format)
        )
      },
      (tweet: Tweet) =&gt; {
        Some((tweet.id.getOrElse(0L), tweet.content, tweet.postedAt.toString, tweet.createdAt.toString, tweet.updatedAt.toString))
      }
    )

    def ? = ((Rep.Some(id), Rep.Some(content), Rep.Some(postedAt), Rep.Some(createdAt), Rep.Some(updatedAt))).shaped.&lt;&gt;({r=&gt;import r._; _1.map(_=&gt; Tweet.tupled((Option(_1.get), _2.get, LocalDateTime.parse(_3.get, format), LocalDateTime.parse(_4.get, format), LocalDateTime.parse(_5.get, format))))}, (_:Any) =&gt;  throw new Exception(&#34;Inserting into ? projection not supported.&#34;))

    val id:        Rep[Long]   = column[Long](&#34;id&#34;, O.AutoInc, O.PrimaryKey)
    val content:   Rep[String] = column[String](&#34;content&#34;, O.Length(120,varying=true))
    val postedAt:  Rep[String] = column[String](&#34;posted_at&#34;)
    val createdAt: Rep[String] = column[String](&#34;created_at&#34;)
    val updatedAt: Rep[String] = column[String](&#34;updated_at&#34;)
  }

  lazy val query = new TableQuery(tag =&gt; new TupleMappedTweetTable(tag))
}
</code></pre>
<p>ã“ã‚Œã¯<code>def *</code>ãªã©ãªã©ã€å¤‰æ›ãŒå¿…è¦ãªå ´æ‰€ãã‚Œãã‚Œã§ä¸å¯§ã«å‡¦ç†ã—ã¦ã„ããƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã­ã€‚<br> å¯¾å¿œæ–¹æ³•ã¨ã—ã¦ã¯ã‚ã‹ã‚Šã‚„ã™ã„ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚</p>
<p>ãŸã ã€å…¨ã¦ã®ãƒ¢ãƒ‡ãƒ«ã‚„å…¨ã¦ã®æ—¥ä»˜å‹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã§ã‚³ãƒ„ã‚³ãƒ„å®Ÿè£…ã‚’ã—ã¦ã‚ã’ãªã„ã¨ã„ã‘ãªã„ã®ã§ãƒ†ãƒ¼ãƒ–ãƒ«æ•°ã‚„æ—¥ä»˜å‹ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†æ•°ãŒå¢—ãˆã‚‹ã¨å¤§å¤‰ã§ã™ã€‚</p>
<p>ãã®ãŸã‚ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã«ã¤ã„ã¦ã¯ã€ã‚„ã¯ã‚Šå¥½ã¾ã—ã„å®Ÿè£…ã§ã¯ãªã•ãã†ã§ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="ä¸€è¦§è¡¨ç¤ºç”»é¢ã®ä¿®æ­£" duration="0">
        <p>ã“ã®ç« ã§ã¯Arrayã§å®Ÿè£…ã•ã‚Œã¦ã„ãŸCRUDã‚’DBã‚’åˆ©ç”¨ã—ãŸå½¢ã«ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚<br> ã¾ãšä¸€è¦§ç”»é¢ã‹ã‚‰ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚<br> ã“ã“ã§ã¯å‰ç« ã§ä½œæˆã—ãŸRepositoryã‚’åˆ©ç”¨ã—ã¦ä¸€è¦§ç”»é¢ãŒè¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚</p>
<h2 is-upgraded>Repositoryã®èª¬æ˜</h2>
<p>å‰ç« ã§Repositoryã‚’ä½œæˆã—ã¾ã—ãŸãŒã€DBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹<code>all()</code>ãƒ¡ã‚½ãƒƒãƒ‰ãŒã•ã‚‰ã£ã¨è¿½åŠ ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<br> ã“ã“ã§ã¯æ”¹ã‚ã¦<code>all()</code>ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚</p>
<p>ä»¥ä¸‹ãŒä»Šå›å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚</p>
<p><code>app/slick/repositories/TweetRepository.scala</code></p>
<pre><code>// ...çœç•¥
private val tweet = new TableQuery(tag =&gt; new TweetTable(tag))

// ########## [DBIO Methods] ##########

/**
  * tweetã‚’å…¨ä»¶å–å¾—
  */
def all(): Future[Seq[Tweet]] = db.run(tweet.result)
</code></pre>
<p>slickã§ã¯TableQueryã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ©ç”¨ã—ã¦Tableã¸ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã„ã¾ã™ã€‚<br> ç´°ã‹ã„å†…éƒ¨ã®å‹•ãã¯å‰²æ„›ã—ã¾ã™ãŒTweetTableã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¸¡ã—ã¦ä½œæˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€Tweetãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ã®å‡¦ç†ãŒè¡Œãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‚ã‘ã§ã™ã­ã€‚<br> ãã‚Œã‚’è¡Œã£ã¦ã„ã‚‹ã®ãŒä»¥ä¸‹ã§ã™ã€‚</p>
<pre><code>private val tweet = new TableQuery(tag =&gt; new TweetTable(tag))
</code></pre>
<p>ãã—ã¦ã“ã“ã§ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã€å®Ÿéš›ã«å•åˆã›ã‚’è¡Œã†ãŸã‚ã®å‡¦ç†ãŒä»¥ä¸‹ã®<code>all()</code>ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚</p>
<pre><code>def all(): Future[Seq[Tweet]] = db.run(tweet.result)
</code></pre>
<p><code>tweet.result</code>ã®éƒ¨åˆ†ãŒqueryã‚’çµ„ã¿ç«‹ã¦ã¦ã„ã‚‹å ´æ‰€ã«ãªã‚Šã¾ã™ã€‚<br> ä»Šå›ã¯ä½•ã‚‚ã›ãšã«ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ä»¶å–å¾—ã—ã¦ã„ã‚‹ã¨ã„ã†Queryã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<p>ã“ã‚Œã ã¨ã‚ã‹ã‚Šã¥ã‚‰ã„ã®ã§ã€ä»–ã«ã‚‚ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã‚’ç´¹ä»‹ã—ã¦ã¿ã¾ã™ã€‚</p>
<pre><code>// idãŒå¶æ•°ã®ã‚‚ã®ã ã‘æŠ½å‡º
def allOdd(): Future[Seq[Tweet]] = db.run(
  tweet.filter(x =&gt; x.id % 2L === 0L).result
)

// idãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’å–å¾—
def findById(id: Long): Future[Seq[Tweet]] = db.run(
  tweet.filter(x =&gt; x.id  === id).result
)
</code></pre>
<p>TableQueryã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚‹tweetå¤‰æ•°ã‚’èµ·ç‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’çµã‚Šè¾¼ã‚“ã§ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã­ã€‚</p>
<p>æœ€å¾Œã«<code>db.run</code>ã®éƒ¨åˆ†ã‚’èª¬æ˜ã—ã¾ã™ã€‚</p>
<p><code>tweet.result</code>ã¯ã¾ã Queryã‚’çµ„ã¿ç«‹ã¦ã ã‘ã®çŠ¶æ…‹ãªã®ã§ã€ã“ã‚Œã ã‘ã§ã¯å®Ÿéš›ã«DBã¸ã®å•ã„åˆã‚ã›ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚<br> å®Ÿéš›ã«DBã¸ã®å‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹ã®ã¯<code>db.run</code>ãŒå®Ÿè¡Œã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚</p>
<p>ã“ã“ãŒplay-slickã®å ´åˆã«ã¯<code>HasDatabaseConfigProvider</code>ã«éš ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> ã“ã®dbã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯é€šå¸¸è‡ªåˆ†ã§ä½œã‚‹ã®ã§ã™ãŒã€play-slickã®å ´åˆã¯ä¸Šè¨˜ã®traitã®ä¸­ã§ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> é€šå¸¸ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€è‡ªåˆ†ã§ç”Ÿæˆã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚</p>
<pre><code>val db = Database.forConfig(&#34;your_db_setting&#34;)
</code></pre>
<p>ã“ã‚Œã§<code>def all()</code>ã®æº–å‚™ã¨ç†è§£ãŒã§ãã¾ã—ãŸã€‚<br> æ¬¡ã¯Controllerã‹ã‚‰ã“ã‚Œã‚’å‘¼ã³å‡ºã—ã¦ä¸€è¦§ã§è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚</p>
<h2 is-upgraded>Controllerã®ä¿®æ­£</h2>
<p>Repositoryã«ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†ã‚’è¿½åŠ ã§ããŸã®ã§ã€ãã‚Œã‚’å‘¼ã³å‡ºã™å´ã®Controllerã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚<br> Controllerã‚¯ãƒ©ã‚¹ã‚‚è¡Œæ•°ãŒå¤§ãããªã£ã¦ã„ã‚‹ã®ã§ã€ä¿®æ­£ã—ãŸéƒ¨åˆ†ã ã‘ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦ã„ãã¾ã™ã­ã€‚</p>
<p><code>app/controllers/tweet/TweetController.scala</code></p>
<pre><code>import slick.models.Tweet
import slick.repositories.TweetRepository

@Singleton
class TweetController @Inject()(
  val controllerComponents: ControllerComponents,
  tweetRepository:          TweetRepository // &lt;= repositoryã‚’DI
)(implicit ec: ExecutionContext)
extends BaseController
with I18nSupport {

// ... çœç•¥ ...

  /**
    * Tweetã‚’ä¸€è¦§è¡¨ç¤º
    *   Action.asyncã¨ã™ã‚‹ã“ã¨ã§returnã®å‹ã¨ã—ã¦Future[Result]ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£
    */
  def list() =  Action async { implicit request: Request[AnyContent] =&gt;
    // DBã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦returnã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
    for {
      results &lt;- tweetRepository.all()
    } yield {
      Ok(views.html.tweet.list(results))
    }
  }

// ... çœç•¥ ...

}
</code></pre>
<p>ä¿®æ­£ç®‡æ‰€ã«ã¤ã„ã¦ã¯ã‚³ãƒ¡ãƒ³ãƒˆã§è£œè¶³ã—ã¦ã„ã¾ã™ãŒã€æ”¹ã‚ã¦ä¸€ã¤ä¸€ã¤èª¬æ˜ã‚’ã—ã¦ã„ãã¾ã™ã€‚<br> ã¾ãšã¯ã‚¯ãƒ©ã‚¹å®£è¨€ã®éƒ¨åˆ†ã§ã™ã€‚</p>
<pre><code>@Singleton
class TweetController @Inject()(
  val controllerComponents: ControllerComponents,
  tweetRepository:          TweetRepository // &lt;= repositoryã‚’DI
)(implicit ec: ExecutionContext)
</code></pre>
<p>ã“ã“ã§ã¯Injectã®å¯¾è±¡ã«repositoryã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚<br> ã“ã†ã™ã‚‹ã“ã¨ã§å®Ÿè¡Œæ™‚ã«<code>tweetRepository</code>ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ³¨å…¥ã—ã¦ãã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãªã„ã§repositoryã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ã¾ãŸRepositoryã‹ã‚‰å—ã‘å–ã£ãŸFutureã‚’å‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§<code>(implicit ec: ExecutionContext)</code>ã‚’è¿½åŠ ã—ã¦ã€Futureã«æ¸¡ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚</p>
<p>æ¬¡ã«listã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡¦ç†ã‚’ã¿ã¦ã¿ã¾ã™ã€‚</p>
<pre><code>def list() =  Action async { implicit request: Request[AnyContent] =&gt;
  // DBã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦returnã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
  for {
    results &lt;- tweetRepository.all()
  } yield {
    Ok(views.html.tweet.list(results))
  }
}
</code></pre>
<p>ä¿®æ­£ã—ã¦ã„ã‚‹ã®ã¯2ãƒ¶æ‰€ã‚ã‚Šã€ä¸€ã¤ãŒ<code>Action async</code>ã®éƒ¨åˆ†ã€‚<br> ã‚‚ã†ä¸€ã¤ãŒæ®‹ã‚Šã®forå¼ã®éƒ¨åˆ†ã§ã™ã­ã€‚</p>
<p>forã®æ›¸ãæ–¹ãŒæ…£ã‚Œã¦ã„ãªã„ã¨ã‚ã‹ã‚Šã¥ã‚‰ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚<br> scalaã®forå¼ã¯map/flatMapã®ç³–è¡£æ§‹æ–‡ã«ãªã£ã¦ãŠã‚Šã€ä»Šå›ã®ã‚ˆã†ã«1æ®µã®å±•é–‹ã®å ´åˆã«ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ã«ãªã‚Šã¾ã™ã€‚</p>
<pre><code>tweetRepository.all().map(results =&gt; 
  Ok(views.html.tweet.list(results))
)
</code></pre>
<p>ä»Šå›tweetRepositoryã®returnãŒFutureå‹ã«ãªã‚‹ã®ã§ã€forå¼ã®returnãŒFuture[Result]å‹ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> Playã§ã¯Actionãƒ¡ã‚½ãƒƒãƒ‰ã¯returnã«Resultå‹ã‚’è¦æ±‚ã—ã¾ã™ãŒã€ã“ã‚Œã«å¯¾ã—ã¦<code>Action async</code>ã¨ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§returnã®å‹è¦æ±‚ã‚’Future[Result]ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p>ãã®ãŸã‚asyncã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚³ãƒ¼ãƒ«ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã®ã§ã™ã€‚<br> ä¿®æ­£å†…å®¹ã¯æ¯”è¼ƒçš„ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ã€‚<br> åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã¯å¤‰ã‚ã£ã¦ã„ãªã„ã®ã§viewå´ã®ä¿®æ­£ã¯ä¸è¦ã§ã™ã€‚</p>
<p>ã“ã“ã¾ã§ä¿®æ­£ãŒçµ‚ã‚ã£ãŸã‚‰ã€ã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br><a href="http://localhost:9000/tweet/list" target="_blank">http://localhost:9000/tweet/list</a></p>
<p>ä»¥ä¸‹ã®ã‚ˆã†ã«ï¼•ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã§ãã¦ã„ã‚Œã°OKã§ã™ã€‚</p>
<p class="image-container"><img style="width: 450.00px" src="img/71cdfe2333dc90b4.png"></p>
<h3 is-upgraded>[è£œè¶³] Actionã¨Action asyncã®é•ã„</h3>
<p>å®Ÿè£…ã¯å®Œäº†ã—ã¦ã„ã¾ã™ãŒã€å°‘ã—Actionã«ã¤ã„ã¦è£œè¶³ã—ã¾ã™ã€‚</p>
<p>å…ˆã»ã©ã®èª¬æ˜ã‚’è¦‹ã‚‹ã¨ã€ŒActionã¯é€æ¬¡å‡¦ç†ã§Action asyncã¯Futureå‡¦ç†ãªã‚“ã ã€ã¨æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚<br> ã—ã‹ã—å®Ÿéš›ã«ã¯Actionã¨Action asyncã«å·®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>ã“ã‚Œã¯<a href="https://www.playframework.com/documentation/2.8.x/ScalaAsync#Actions-are-asynchronous-by-default" target="_blank">å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>ã«ã‚‚Noteã¨ã—ã¦è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<pre><code>Note: Both Action.apply and Action.async create Action objects that are handled internally in the same way.
There is a single kind of Action, which is asynchronous, and not two kinds (a synchronous one and an asynchronous one).
The .async builder is just a facility to simplify creating actions based on APIs that return a Future, which makes it easier to write non-blocking code.
</code></pre>
<p>æ„è¨³ã™ã‚‹ã¨ã€Œã©ã£ã¡ã‚‚åŒã˜ã§2ç¨®é¡ã‚ã‚‹ã‚ã‘ã§ã¯ãªã„ã‚ˆã€ã¨æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚<br> è¨€è‘‰ã ã‘ã ã¨ä¿¡ã˜ãŒãŸã„ã®ã§ã€å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚‚è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<p>playã®Actionã®applyãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<pre><code>/**
 * Constructs an `Action` with default content.
 *
 * For example:
 * &#123;&#123;{
 * val echo = Action { request =&gt;
 *   Ok(&#34;Got request [&#34; + request + &#34;]&#34;)
 * }
 * }}}
 *
 * @param block the action code
 * @return an action
 */
final def apply(block: R[B] =&gt; Result): Action[B] = async(block.andThen(Future.successful))
</code></pre>
<p>Actionã®å‡¦ç†ã¨ã—ã¦æ›¸ã„ã¦ã„ãŸblockã‚’Futureã«åŒ…ã‚“ã§asyncã¸æ¸¡ã—ã¦ã„ã¾ã™ã­ã€‚<br> ã¤ã¾ã‚Šã©ã®ã‚ˆã†ã«æ›¸ã„ã¦ã‚‚çµå±€asyncã«æ¸¡ã•ã‚Œã¦ã„ãã¨ã„ã†ã“ã¨ã§ã™ã€‚</p>
<p>Action, Action asyncã®ä½¿ã„åˆ†ã‘ã¯bodyå†…ã®å‡¦ç†ãŒreturnã™ã‚‹å‹ãŒæ›¸ãã‚„ã™ã„æ–¹ã‚’ä½¿ãˆã°ã„ã„ã‚ã‘ã§ã™ã­ã€‚<br> ã“ã®ã‚ãŸã‚ŠãŒæœ€åˆã¯æ…£ã‚Œã¾ã›ã‚“ãŒã€é€šå¸¸DBã‚„APIã‚³ãƒ¼ãƒ«ã‚’ã™ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã ã„ãŸã„asyncã«è½ã¡ç€ãã¾ã™ã‚ˆã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="è©³ç´°ç”»é¢ã®ä¿®æ­£" duration="0">
        <p>ä¸€è¦§ç”»é¢ãŒã§ããŸã®ã§ã€ç¶šã„ã¦è©³ç´°ç”»é¢ã®ä¿®æ­£ã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚</p>
<h2 is-upgraded>Repositoryã®ä¿®æ­£</h2>
<p>è©³ç´°ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ã‚’1ä»¶å–å¾—ã™ã‚‹å‡¦ç†ã‚’Repositoryã«è¿½åŠ ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
<p><code>app/slick/repositories/TweetRepository.scala</code></p>
<pre><code>/**
 * idã‚’æŒ‡å®šã—ã¦Tweetã‚’å–å¾—
 */
def findById(id: Long): Future[Option[Tweet]] = db.run(
  tweet.filter(x =&gt; x.id  === id).result.headOption
)
</code></pre>
<p>sampleã§ä½œæˆã—ã¦ã„ãŸå‡¦ç†ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯ä¸»ã‚­ãƒ¼ã§ã‚ã‚‹idã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚Optionå‹ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚<br> filterã¯SQLã§ã„ã†ã¨ã“ã‚ã®<code>whereå</code>¥ã«ã‚ãŸã‚Šã¾ã™ã€‚<br> å˜ç´”ã«filterã‚’è¡Œã†ã¨ãƒ‡ãƒ¼ã‚¿ãŒSeqã¨ãªã‚‹ãŸã‚ã€headOptionã§Optionã¨ã—ã¦å–å¾—ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚</p>
<p>æ…£ã‚Œã¦ã—ã¾ã†ã¨Scalaã§mutableã®Arrayã‚’æ‰±ã†ã‚ˆã‚Šã‚‚ã€ã“ã¡ã‚‰ã®æ–¹ãŒä½™ç¨‹å˜ç´”ã§ã™ã€‚</p>
<p>ã¡ãªã¿ã«åŸºæœ¬çš„ãªã‚¯ã‚¨ãƒªã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã«èª¬æ˜ãŒã‚ã‚Šã¾ã™ã®ã§ã€ä»Šå¾Œã®å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚<br><a href="https://scala-slick.org/doc/3.3.1/queries.html" target="_blank">Slick Queries</a></p>
<h2 is-upgraded>Controllerã®ä¿®æ­£</h2>
<p>ä¸€è¦§ã®æ™‚ã®ä¿®æ­£ã‚’å‚è€ƒã«ã€ã“ã¡ã‚‰ã‚‚å‡¦ç†ã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
<p><code>app/controllers/tweet/TweetController.scala</code></p>
<pre><code>  /**
    * å¯¾è±¡IDã®Tweetè©³ç´°ã‚’è¡¨ç¤º
    */
  def show(id: Long) = Action async { implicit request: Request[AnyContent] =&gt;
    // idãŒå­˜åœ¨ã—ã¦ã€å€¤ãŒä¸€è‡´ã™ã‚‹å ´åˆã«findãŒæˆç«‹
    for {
      tweetOpt &lt;- tweetRepository.findById(id)
    } yield {
      tweetOpt match {
        case Some(tweet) =&gt; Ok(views.html.tweet.show(tweet))
        case None        =&gt; NotFound(views.html.error.page404())
      }
    }
  }
</code></pre>
<p>ä»Šå›ã‚‚Actionã‚’<code>async</code>ã«ã—ã¦forå¼ã‚’åˆ©ç”¨ã—ã¦Futureã‚’å‡¦ç†ã—ã¦ã„ã¾ã™ã€‚<br> å˜ç´”ãªå‡¦ç†ã§ã‚ã‚Œã°ã“ã®å½¢å¼ã§å‡¦ç†ã§ãã¦ã—ã¾ã†ã®ã§è¦‹ã‚„ã™ããªã‚Šã¾ã™ã­ã€‚</p>
<p>å‰å›ã«å¼•ãç¶šãViewã«æ¸¡ã™ãƒ¢ãƒ‡ãƒ«ã¯å¤‰ã‚ã£ã¦ã„ãªã„ã®ã§ã€å…¨ä½“ã®ä¿®æ­£ã¯ä»¥ä¸Šã§ã™ã€‚</p>
<p>æ—©é€Ÿè©³ç´°ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br><a href="http://localhost:9000/tweet/1" target="_blank">http://localhost:9000/tweet/1</a></p>
<p>æ­£å¸¸ã«ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="æ›´æ–°ç”»é¢ã®ä¿®æ­£" duration="0">
        <p>è©³ç´°ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã§ããŸã®ã§ã€å¼•ãç¶šãæ›´æ–°ç”»é¢ã®ä¿®æ­£ã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚</p>
<h2 is-upgraded>Repositoryã®ä¿®æ­£</h2>
<p>ä»Šå›ã¯2ã¤ã»ã©Repositoryå®Ÿè£…ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ãŸã€‚<br> ä»¥ä¸‹ã«å®Ÿè£…ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚</p>
<p><code>app/slick/repositories/TweetRepository.scala</code></p>
<pre><code>/**
 * å¯¾è±¡ã®tweetã‚’æ›´æ–°ã™ã‚‹
 */
def update(tweet: Tweet): Future[Option[Tweet]] = db.run {
  val row = query.filter(_.id === tweet.id)
  for {
    old &lt;- row.result.headOption
    _    = old match {
      case Some(_) =&gt; row.update(tweet)
      case None    =&gt; DBIO.successful(0)
    }
  } yield old
}

/**
 * å¯¾è±¡ã®Tweetã®å†…å®¹ã‚’æ›´æ–°ã™ã‚‹
 */
def updateContent(id: Long, content: String): Future[Int] = {
  db.run(
    query.filter(_.id === id).map(_.content).update(content)
  )
}
</code></pre>
<p><code>update</code>ãƒ¡ã‚½ãƒƒãƒ‰ãŒãƒ¢ãƒ‡ãƒ«å…¨ä½“ã®æ›´æ–°ã§<code>updateContent</code>ãƒ¡ã‚½ãƒƒãƒ‰ã¯contentã®ã¿ã®å¤‰æ›´ã§ã™ã€‚<br> æ„å›³çš„ã«é•ã†æ›¸ãæ–¹ã‚’ã—ã¦ã„ã¾ã™ãŒã€updateã®æ–¹ã‚‚ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒå¯èƒ½ã§ã™ã€‚</p>
<pre><code>def update(tweet: Tweet): Future[Int] = db.run(
  query.filter(_.id === tweet.id).update(tweet)
)
</code></pre>
<p>ã“ã¡ã‚‰ã®æ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ã€‚</p>
<p>å…ƒã®<code>update</code>ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’returnã™ã‚‹ãŸã‚ã«ã€ã‚„ã‚„å›ã‚Šãã©ã„å®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã¯ä¸€ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­ã§ã„ãã¤ã‹ã®å‡¦ç†ã‚’é€£ç¶šã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦è¨˜è¼‰ã—ã¦ã¿ã¾ã—ãŸã€‚</p>
<p>ã¡ãªã¿ã«DBIO.successfulã‚’åˆ©ç”¨ã™ã‚‹ã¨æ­£å¸¸ç³»ã¨ã—ã¦å¼•æ•°ã«æ¸¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’returnã§ãã¾ã™ã€‚<br> ä½•ã‹ã®æ‹å­ã«åˆ©ç”¨ã—ãŸããªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã®ã§ã€Slickã«ã‚‚Future.successfulã¿ãŸã„ãªã‚‚ã®ãŒã‚ã‚‹ã‚“ã ãªã€ç¨‹åº¦ã«é ­ã®ä¸­ã«æ®‹ã—ã¦ãŠã„ã¦ã„ãŸã ã‘ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚</p>
<h2 is-upgraded>Controllerã®ä¿®æ­£</h2>
<p>Repositoryã®æº–å‚™ãŒã§ããŸã®ã§ã€æ¬¡ã¯Controllerã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚<br> å¤‰æ›´ç”»é¢ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã«ã€ä»Šå›ã¯<code>edit</code>ã¨<code>update</code>ã®2ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£ã—ã¾ã™ã€‚</p>
<p>ã¾ãšæœ€åˆã«<code>edit</code>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚</p>
<pre><code>/**
  * ç·¨é›†ç”»é¢ã‚’é–‹ã
  */
def edit(id: Long) = Action async { implicit request: Request[AnyContent] =&gt;
  for {
    tweetOpt &lt;- tweetRepository.findById(id)
 } yield {
   tweetOpt match {
     case Some(tweet) =&gt;
       Ok(views.html.tweet.edit(
         // ãƒ‡ãƒ¼ã‚¿ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®idã‚’æ¸¡ã™
         id,
         // fillã§formã«å€¤ã‚’è©°ã‚ã‚‹
         form.fill(TweetFormData(tweet.content))
       ))
     case None        =&gt;
       NotFound(views.html.error.page404())
   }
 }
}
</code></pre>
<p>åŸºæœ¬çš„ãªä¿®æ­£ã¯ä»Šã¾ã§åŒæ§˜ã§ã€ã¾ãšã¯<code>Action</code>ã‚’<code>Action async</code>ã«ä¿®æ­£ã—ã¦ã„ã¾ã™ã€‚<br> ã¾ãŸä»Šã¾ã§tweesã®Arrayã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’findã—ã¦ã„ãŸã‚‚ã®ã‚’slickã®<code>findById</code>ã‹ã‚‰å–å¾—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚</p>
<p>ç·¨é›†ç”»é¢ã®è¡¨ç¤ºã¯ã“ã‚Œã§å®Œäº†ã§ã™ã­ã€‚<br> ç¶šã„ã¦ã€å®Ÿéš›ã®æ›´æ–°å‡¦ç†ã§ã‚ã‚‹<code>update</code>ã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>/**
  * å¯¾è±¡ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹
  */
def update(id: Long) = Action async { implicit request: Request[AnyContent] =&gt;
  form.bindFromRequest().fold(
    (formWithErrors: Form[TweetFormData]) =&gt; {
      Future.successful(BadRequest(views.html.tweet.edit(id, formWithErrors)))
    },
    (data: TweetFormData) =&gt; {
      for {
        count &lt;- tweetRepository.updateContent(id, data.content)
      } yield {
        count match {
          case 0 =&gt; NotFound(views.html.error.page404())
          case _ =&gt; Redirect(routes.TweetController.list())
        }
      }
    }
    )
}
</code></pre>
<p>ã“ã¡ã‚‰ã‚‚Futureã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚<code>Action async</code>ã«ã—ã¦Future[Result]ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚<br> ä»–ã«ã¯ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®å‡¦ç†ã‚’slickã‚’åˆ©ç”¨ã—ãŸã‚‚ã®ã«ä¿®æ­£ã—ã¦ã„ã¾ã™ã­ã€‚<br> ä»¥ä¸‹ã®éƒ¨åˆ†ãŒè©²å½“ã™ã‚‹ç®‡æ‰€ã§ã™ã€‚</p>
<pre><code>for {
  count &lt;- tweetRepository.updateContent(id, data.content)
} yield {
  count match {
    case 0 =&gt; NotFound(views.html.error.page404())
    case _ =&gt; Redirect(routes.TweetController.list())
  }
}
</code></pre>
<p>updateå‡¦ç†ã¯æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ•°ã‚’Intã§è¿”ã™ãŸã‚<code>case 0</code>ã¨ãã‚Œä»¥å¤–ã§å‡¦ç†ã‚’åˆ†ã‘ã¦ã„ã¾ã™ã€‚<br> ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãŒ0ä»¶ã¨ã„ã†ã®ã¯ã€ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ãŒå¯¾è±¡ã«å–ã‚‰ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ãªã®ã§404ã¨ã—ã¦ã„ã¾ã™ã€‚<br> æ­£å¸¸ç³»ã¯ä»Šã¾ã§ã¨åŒæ§˜ã§ã™ã­ã€‚</p>
<p>ã¾ãŸã‚‚ã†ä¸€ã¤ä»¥ä¸‹ã‚‚ä¿®æ­£ã—ã¦ã„ã¾ã™ã€‚</p>
<pre><code>Future.successful(BadRequest(views.html.tweet.edit(id, formWithErrors)))
</code></pre>
<p>ã“ã¡ã‚‰ã¯formã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã®returnã§ã™ã­ã€‚<br><code>Action async</code>ã«ãªã£ãŸå½±éŸ¿ã§ã€ã“ã¡ã‚‰ã®Resultã‚’Futureã§å›²ã£ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> ãã®ãŸã‚ã«æ­£å¸¸ã«æˆåŠŸã—ãŸFutureå‹ã¨ã—ã¦ã€ä½•ã‚‚ã—ãªã„Futureã‚’ã¤ãã‚‹<code>Future.successful</code>ã§å‡¦ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã§returnã®å‹ãŒ<code>Future[Result]</code>ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ä¾‹ã«ã‚ˆã£ã¦viewã®ä¿®æ­£ã¯ä¸è¦ãªãŸã‚ã€ã“ã‚Œã§ä¿®æ­£ã¯å®Œäº†ã§ã™ã€‚<br> ä»¥ä¸‹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚<br><a href="http://localhost:9000/tweet/1/edit" target="_blank">http://localhost:9000/tweet/1/edit</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="ç™»éŒ²ç”»é¢ã®ä¿®æ­£" duration="0">
        <p>ä¸€è¦§ã‹ã‚‰ã®æµã‚Œã®ä¿®æ­£ãŒå®Œäº†ã—ãŸã®ã§ã€æ¬¡ã¯ç™»éŒ²ç”»é¢ã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚</p>
<h2 is-upgraded>Repositoryã®ä¿®æ­£</h2>
<p>slickã§ã®ç™»éŒ²æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚</p>
<p><code>app/slick/repositories/TweetRepository.scala</code></p>
<pre><code>/**
 * tweetã‚’1ä»¶ç™»éŒ²ã™ã‚‹
 */
def insert(tweet: Tweet): Future[Long]= db.run(
  // returningãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«æŒ‡å®šã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²çµæœã¨ã—ã¦è¿”å´ã™ã‚‹ã‚ˆã†ã«ã§ãã‚‹
  (query returning query.map(_.id)) += tweet
)
</code></pre>
<p>ç™»éŒ²å‡¦ç†ã®éƒ¨åˆ†ã§è¦‹æ…£ã‚Œãªã„ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‡ºã¦ãã¦ã„ã¾ã™ã€‚<br> å®Ÿã¯ç™»éŒ²å‡¦ç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ã‚‚ã§ãã‚‹ã‚“ã§ã™ã€‚</p>
<pre><code>/**
 * tweetã‚’1ä»¶ç™»éŒ²ã™ã‚‹
 */
def insert(tweet: Tweet): Future[Int]= db.run(
  query += tweet
)
</code></pre>
<p>ã“ã¡ã‚‰ã®æ–¹ãŒè¦‹ãŸç›®ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚<br> ã§ã¯ã€ã“ã®äºŒã¤ã®ä½•ãŒé•ã†ã¨è¨€ã†ã¨ã€ãã‚Œã¯æœ€çµ‚çš„ã«è¿”ã•ã‚Œã‚‹çµæœã®å€¤ã§ã™ã€‚</p>
<p>æœ€åˆã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã‚‚æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒ<code>returning</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€ç™»éŒ²å¾Œã«ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨ã‚’è¿”å´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br> ä»Šå›idã¯DBã®Tableå´ã§AutoIncè¨­å®šãŒã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç™»éŒ²æ™‚ã«ã¯æœªç¢ºå®šã§ã™ã€‚<br> ç™»éŒ²å¾Œã«ãã®idã‚’åˆ©ç”¨ã—ã¦é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã™ã‚‹ã‚±ãƒ¼ã‚¹ãªã©ã‚’è€ƒãˆã‚‹ã¨ã€å®Ÿéš›ã«ç™»éŒ²ã•ã‚ŒãŸidãŒæ¬²ã—ããªã‚Šã¾ã™ã‚ˆã­ã€‚<br> ãã®ãŸã‚<code>query.map(_.id)</code>ã¨ã„ã†å½¢ã§idã‚’è¿”å´ã™ã‚‹ã‚ˆã†ã«<code>returning</code>ã«æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ã™ã€‚</p>
<p>ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹ã¨ã€ãã†ã„ã†æ–‡æ³•ã®ã‚ˆã†ã«è¦‹ãˆã¦ã—ã¾ã„ã¾ã™ãŒã€å®Ÿéš›ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<pre><code>  (query.returning(query.map(_.id))).+=(tweet)
</code></pre>
<p><code>query.map(_.id)</code>ã®éƒ¨åˆ†ã¯returningã®å¼•æ•°ã«ãªã£ã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚<br> ã“ã‚Œã«ã‚ˆã‚Šã€ç™»éŒ²ã‚’è¡Œã„ã¤ã¤ç™»éŒ²ã•ã‚ŒãŸidã‚’å‘¼ã³å‡ºã—å´ã§å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</p>
<p>ã¾ãŸTableã®å‹ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Optionã§ã¯ãªã„Longå‹ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<pre><code>val id: Rep[Long] = column[Long](&#34;id&#34;, O.AutoInc, O.PrimaryKey)
</code></pre>
<p>ä»Šå›ã®Tweetãƒ¢ãƒ‡ãƒ«ã®idã¯Option[Long]ãªã®ã§ã™ãŒã€columnå®šç¾©ã«<code>O.AutoInc</code>ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«ã‚ˆã‚Šç™»éŒ²æ™‚ã«idã®å€¤ãŒç„¡è¦–ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã«ã‚ˆã‚Štweetãƒ¢ãƒ‡ãƒ«ã‚’ãã®ã¾ã¾ç™»éŒ²å‡¦ç†ã«æ¸¡ã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚</p>
<p>ã“ã®èª¬æ˜ã¯<a href="http://scala-slick.org/doc/3.3.1/queries.html#inserting" target="_blank">ã“ã“</a>ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã«èª¬æ˜æ–‡ã‚’æŠœç²‹ã—ã¾ã™ã€‚</p>
<pre><code>When you include an AutoInc column in an insert operation, it is silently ignored, so that the database can generate the proper value.
In this case you usually want to get back the auto-generated primary key column.
By default, += gives you a count of the number of affected rows (which will usually be 1) and ++= gives you an accumulated count in an Option (which can be None if the database system does not provide counts for all rows).
This can be changed with the returning method where you specify the columns to be returned (as a single value or tuple from += and a Seq of such values from ++=):
</code></pre>
<p>Repositoryã®å®Ÿè£…ã¨èª¬æ˜ã¯ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚</p>
<h2 is-upgraded>Controllerã®ä¿®æ­£</h2>
<p>å¼•ãç¶šãã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ä¿®æ­£ã‚’è¡Œã„ã¾ã™ã€‚<br> æ›´æ–°å‡¦ç†ã¨åŒã˜ã‚ˆã†ã«ã€ä»Šå›ã¯<code>register</code>ã¨<code>store</code>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚’ã¿ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
<p>ã¾ãšã¯<code>register</code>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚</p>
<p><code>app/controllers/tweet/TweetController.scala</code></p>
<pre><code>/**
  * ç™»éŒ²ç”»é¢ã®è¡¨ç¤ºç”¨
  */
def register() = Action { implicit request: Request[AnyContent] =&gt;
  Ok(views.html.tweet.store(form))
}
</code></pre>
<p>ã“ã¡ã‚‰ã¯ä¿®æ­£å‰ã®ã¾ã¾ã®çŠ¶æ…‹ãªã®ã§ã™ãŒã€ç‰¹ã«ä¿®æ­£ã¯å¿…è¦ãªã•ãã†ã§ã™ã­ã€‚<br> ç™»éŒ²ç”»é¢ã¯ç‰¹ã«ç”»é¢ä¸Šã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ä»Šå›ã®DBåˆ©ç”¨ã®ãŸã‚ã®ä¿®æ­£ã®å½±éŸ¿ã¯å—ã‘ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚</p>
<p>ã§ã¯ã€æ¬¡ã¯å®Ÿéš›ã®ç™»éŒ²å‡¦ç†ã§ã‚ã‚‹<code>store</code>ã§ã™ã€‚</p>
<p><code>app/controllers/tweet/TweetController.scala</code></p>
<pre><code>**
 * ç™»éŒ²å‡¦ç†å®Ÿã‚’è¡Œã†
 */
def store() = Action async { implicit request: Request[AnyContent] =&gt;
  // foldã§ãƒ‡ãƒ¼ã‚¿å—ã‘å–ã‚Šã®æˆåŠŸã€å¤±æ•—ã‚’åˆ†å²ã—ã¤ã¤å‡¦ç†ãŒè¡Œãˆã‚‹
  form.bindFromRequest().fold(
    // å‡¦ç†ãŒå¤±æ•—ã—ãŸå ´åˆã«å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
    (formWithErrors: Form[TweetFormData]) =&gt; {
      Future.successful(BadRequest(views.html.tweet.store(formWithErrors)))
    },
    // å‡¦ç†ãŒæˆåŠŸã—ãŸå ´åˆã«å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
    (tweetFormData: TweetFormData) =&gt; {
      for {
        // ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã€‚returnã®idã¯ä¸è¦ãªã®ã§æ¨ã¦ã‚‹
        _ &lt;- tweetRepository.insert(Tweet(None, tweetFormData.content))
      } yield {
        Redirect(routes.TweetController.list())
      }
    }
  )
}
</code></pre>
<p>ç™»éŒ²å‡¦ç†ã®ä¿®æ­£ã¯åŸºæœ¬çš„ã«æ›´æ–°å‡¦ç†ã¨åŒæ§˜ã§ã™ã€‚<br><code>Action</code>ã‚’<code>Action async</code>ã¨ã—ã¦å¤±æ•—æ™‚ã€æˆåŠŸæ™‚å…±ã«Futureã§å‡¦ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚<br> ç™»éŒ²å‡¦ç†ã‚‚repositoryã®å‡¦ç†ã‚’å‘¼ã³å‡ºã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã­ã€‚</p>
<p>returningã®èª¬æ˜ã‚’ã—ãŸå¾Œã§ã¯ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯è¿”å´ã•ã‚Œã‚‹idã®å€¤ã¯åˆ©ç”¨ã—ãªã„ã®ã§<code>_</code>ã«æ¨ã¦ã¦ã„ã¾ã™ã€‚</p>
<p>æ›´æ–°å‡¦ç†ã§ä¸€åº¦è¡Œã£ã¦ã„ã‚‹ã®ã§ã€å˜ç´”ã§ã¯ã‚ã‚Šã¾ã™ãŒä¿®æ­£ãŒã§ããŸã‚‰å‹•ä½œã‚’ã¿ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br><a href="http://localhost:9000/tweet/store" target="_blank">http://localhost:9000/tweet/store</a></p>
<p>ç”»é¢è¡¨ç¤ºã¨ç™»éŒ²å‡¦ç†ã¾ã§ç¢ºèªã§ããŸã‚‰å®Œäº†ã§ã™ï¼</p>


      </google-codelab-step>
    
      <google-codelab-step label="å‰Šé™¤å‡¦ç†ã®ä¿®æ­£" duration="0">
        <p>æœ€å¾Œã¯å‰Šé™¤å‡¦ç†ã®ä¿®æ­£ã§ã™ã€‚<br> ã“ã‚Œã§CRUDã®æœ€å¾Œã®ä¸€ã¤ã§ã™ã­ã€‚</p>
<h2 is-upgraded>Repositoryã®ä¿®æ­£</h2>
<p>ä¾‹ã«ã‚ˆã£ã¦Repositoryã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚</p>
<p><code>app/slick/repositories/TweetRepository.scala</code></p>
<pre><code>/**
 * å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹
 */
def delete(id: Long): Future[Int] = delete(Some(id))

/**
 * å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹
 */
def delete(idOpt: Option[Long]) = db.run(
  query.filter(_.id === idOpt).delete
)
</code></pre>
<p>ã“ã¡ã‚‰ãŒå‰Šé™¤å‡¦ç†ã®å®Ÿè£…ã«ãªã‚Šã¾ã™ã€‚<br> å®Ÿè£…è‡ªä½“ã¯å¤‰æ›´å‡¦ç†ã¨ä¼¼ã¦ã„ã¾ã™ã­ã€‚<br><code>delete</code>ã‚‚returnã¯Intã«ãªã£ã¦ã„ã¦ã€å‰Šé™¤ã•ã‚ŒãŸä»¶æ•°ãŒè¿”ã•ã‚Œã¾ã™ã€‚</p>
<p>ã ãŸã€ä»Šå›ã¯overloadã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ç”¨æ„ã—ã¦ã¿ã¾ã—ãŸã€‚<br> ã“ã®å‡¦ç†ã§ã¯ä¸»ã‚­ãƒ¼ã‚’åˆ©ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’filterã—ã¦ã„ã‚‹ãŸã‚ã€Option[Long]ã«å¯¾ã—ã¦filterãŒã‹ã‘ã‚‰ã‚Œã¾ã™ã€‚<br> ãã‚Œã‚’åˆ©ç”¨ã—ã¦Option[Long]ã‚’å—ã‘å–ã‚‹<code>delete</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ¡ã‚¤ãƒ³ã«ã—ã¤ã¤ã€Longã‚’ç›´æ¥å—ã‘å–ã‚‹<code>delete</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å®šç¾©ã—ã¦ã„ã¾ã™ã€‚</p>
<p>ã“ã®ã‚ˆã†ãªã“ã¨ã‚’ã—ãªãã¦ã‚‚å‘¼ã³å‡ºã™å´ã§ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<pre><code>idOpt.map(tweetRepository.delete)
</code></pre>
<p>ãŸã ã€ã›ã£ã‹ãLong, Option[Long]ã®ã©ã¡ã‚‰ã‚‚æ‰±ãˆã‚‹ã®ã§ãã®ã¾ã¾æ¸¡ã›ã‚‹ã‚ˆã†ã«ã—ã¡ã‚ƒã„ã¾ã—ãŸã€‚<br> å°‘ã—è„±ç·šã—ã¾ã—ãŸãŒã€deleteå‡¦ç†ã«ã¤ã„ã¦ã¯ä»¥ä¸Šã§ã™ã€‚</p>
<h2 is-upgraded>Controllerã®ä¿®æ­£</h2>
<p>ä½œæˆã—ãŸ<code>delete</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ©ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚</p>
<pre><code>/**
 * å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹
 */
def delete() = Action async { implicit request: Request[AnyContent] =&gt;
  // requestã‹ã‚‰ç›´æ¥å€¤ã‚’å–å¾—ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«
  val idOpt = request.body.asFormUrlEncoded.get(&#34;id&#34;).headOption
  for {
    // stringã‹ã‚‰longã¸parseã§ããªã„å ´åˆãŒã‚ã‚‹ãŸã‚å¾¡è¡Œå„€ã¯æ‚ªã„
    result &lt;- tweetRepository.delete(idOpt.map(_.toLong)) 
  } yield {
    // å‰Šé™¤å¯¾è±¡ã®æœ‰ç„¡ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†å²
    result match {
      case 0 =&gt; NotFound(views.html.error.page404())
      case _ =&gt; Redirect(routes.TweetController.list())
    }
  }
}
</code></pre>
<p>ä»Šå›ã¯Option[Long]ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã®ã‚ˆã†ãªå‡¦ç†ã«ãªã‚Šã¾ã™ã€‚<br> å¤‰æ›´å‡¦ç†ã«ä¼¼ã¦ã„ã¾ã™ã­ã€‚</p>
<p>urlã‹ã‚‰å—ã‘ã¨ã£ãŸidã¯stringã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€mapã§Longå‹ã«å¤‰æ›ã‚’ã‹ã‘ã¦ã„ã¾ã™ã€‚<br> æœ¬æ¥ã¯æ–‡å­—åˆ—ãŒã¡ã‚ƒã‚“ã¨æ•°å€¤ã«å¤‰æ›ã§ãã‚‹ã‚‚ã®ãªã®ã‹ç¢ºèªå‡¦ç†ãŒå¿…è¦ã§ã™ãŒã€ã“ã‚Œã¯urlã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†ã®ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦è¨˜è¼‰ã—ã¦ã‚‹ã®ã§ã€ãã®è¾ºã‚Šã®ã‚±ã‚¢ã¯å‰²æ„›ã—ã¦ã„ã¾ã™ã€‚</p>
<p>ã•ãã€ã“ã“ã¾ã§æ›¸ã‘ãŸã‚‰å‹•ä½œã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br><a href="http://localhost:9000/tweet/list" target="_blank">http://localhost:9000/tweet/list</a></p>
<p>å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã§ãã¦ã„ã‚Œã°OKã§ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="ã¾ã¨ã‚" duration="0">
        <p>ã“ã‚Œã§å…¨ã¦ã®å‡¦ç†ã‚’DBã‚’åˆ©ç”¨ã—ãŸå‡¦ç†ã«ä¿®æ­£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚<br> slickã¯æœ€åˆã®è¨­å®šãŒç…©é›‘ãªãŸã‚ã€ç‹¬å­¦ã§åˆ©ç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã¨é›£ã—ãæ„Ÿã˜ã‚‹ã“ã¨ãŒå¤šã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</p>
<p>ä»Šã¯ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’åˆ©ç”¨ã—ã¦Play-Slickã§ã®é–‹ç™ºã«æ…£ã‚Œã¦ã„ãã€ä½™è£•ãŒå‡ºã¦ããŸã‚‰ä¸€ã¤ä¸€ã¤èª­ã¿è§£ã„ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
